---
title: "PhRMA & EFPIA R&D Analysis"
author: "Bena Smith"
output:
  html_document:
    
    df_print: paged
  pdf_document:
      extra_dependencies: 
        dcolumn: null
editor_options: 
  markdown: 
    wrap: 72
---

```         
includes:
  in_header: preamble.tex
  
```

```{r}
library(ggplot2)
library(plm)
library(lmtest)
library(sandwich)
library(janitor)
library(dplyr)
library(readxl)
library(writexl)
library(lubridate)
library(readr)
library(nlme)
library(stringr)
library(broom)
library(tidyr)
library(stargazer)
library(PerformanceAnalytics)
library(Metrics)
library(scales)
library(car)
library(glue)
```

# EFPIA/ Europe

## EFPIA R&D spending by country by year in euros

From yearly R&D reports 2004: Link Removed. Screenshot can be found in
original data folder 2005:
<https://www.efpia.eu/media/15485/the-pharmaceutical-industry-in-figures-edition-2007.pdf>
2006:
<https://www.efpia.eu/media/15486/the-pharmaceutical-industry-in-figures-edition-2008.pdf>
2007:
<https://www.pharmine.eu/wp-content/uploads/2014/04/The_Pharma_Industry_in_figures_Edition_2009-20080612-009-EN-v1.pdf>
2008:
<https://www.sfee.gr/wp-content/uploads/2015/05/Figures_2010_Final-20100611-001-EN-v1_0.pdf>
2009:
<https://www.efpia.eu/media/15489/the-pharmaceutical-industry-in-figures-edition-2011.pdf>
2010:
<https://www.sfee.gr/wp-content/uploads/2015/05/EFPIA_Figures_2012_Final.pdf>
Data for 2011 could not be found 2012:
<https://www.phar-in.eu/wp-content/uploads/2014/05/Figures_2014_Final.pdf>
2013:
<https://www.efpia.eu/media/25822/2015-the-pharmaceutical-industry-in-figures.pdf>
2014:
<https://www.efpia.eu/media/25055/the-pharmaceutical-industry-in-figures-june-2016.pdf>
2015:
<https://www.efpia.eu/media/219735/efpia-pharmafigures2017_statisticbroch_v04-final.pdf>
2016:
<https://www.efpia.eu/media/361960/efpia-pharmafigures2018_v07-hq.pdf>
2017:
<https://www.efpia.eu/media/412931/the-pharmaceutical-industry-in-figures-2019.pdf>
2018:
<https://www.efpia.eu/media/554521/efpia_pharmafigures_2020_web.pdf>
2019:
<https://www.efpia.eu/media/602709/the-pharmaceutical-industry-in-figures-2021.pdf>
2020:
<https://www.efpia.eu/media/637143/the-pharmaceutical-industry-in-figures-2022.pdf>
2021:
<https://www.efpia.eu/media/rm4kzdlx/the-pharmaceutical-industry-in-figures-2023.pdf>

```{r}
efpia_rd <- read.csv("Cleaned Data/Area Level R&D Spending/EFPIA R&D Spending by Country in EU.csv")
efpia_rd <- clean_names(efpia_rd)
efpia_rd
```

Formatting - removing commas 

```{r}
efpia_rd$r_d_spending_millions_euros <- gsub(",", "", efpia_rd$r_d_spending_millions_euros)
efpia_rd$r_d_spending_millions_euros <- as.numeric(efpia_rd$r_d_spending_millions_euros)
efpia_rd
```

sum total EU by year

```{r}
efpia_rd_totals <- efpia_rd %>%
  group_by(year) %>%
  summarise(total_mil_euros = sum(r_d_spending_millions_euros, na.rm = TRUE))
efpia_rd_totals

```

Imputing 2011 with average between 2011 and 2012 efpia_rd_totals

```{r}
rd_2012 <- efpia_rd_totals[efpia_rd_totals$year == 2012, ]$total_mil_euros
rd_2010 <- efpia_rd_totals[efpia_rd_totals$year == 2010, ]$total_mil_euros
avg_2010_2012 <- (rd_2010 + rd_2012) / 2

efpia_rd_totals <- rbind(efpia_rd_totals, c(2011, avg_2010_2012))
efpia_rd_totals <- efpia_rd_totals[order(efpia_rd_totals$year),]
efpia_rd_totals
```

Euros to Dollars
<https://www.macrotrends.net/2548/euro-dollar-exchange-rate-historical-chart>

```{r}
eurotousdavgconversion <- read_xlsx("Original Data/USD to Euro Conversion Avg by Year.xlsx")
eurotousdavgconversion
eurotodollars <- as.data.frame(cbind(eurotousdavgconversion$Year, eurotousdavgconversion$`Average Closing Price`))
colnames(eurotodollars) <- c("year", "euros_to_dollar_conversion")
eurotodollars
```


Multiply euros by conversion rate to get r&d spending in dollars

```{r}
rd_conversion_merged_df <- merge(efpia_rd_totals, eurotodollars, by = "year")
rd_conversion_merged_df
efpia_rd_totals$total_rd_mil_dollars <- rd_conversion_merged_df$euros_to_dollar_conversion * rd_conversion_merged_df$total_mil_euros
efpia_rd_totals$annual_domestic_RD_spending_bil_dollars <- efpia_rd_totals$total_rd_mil_dollars /1000

efpia_rd_totals
```

## EU orphan drug market authorizations

EU Orphan Drugs were scraped from the pdf:
<https://www.orpha.net/pdfs/orphacom/cahiers/docs/GB/list_of_orphan_drugs_in_europe.pdf>
It can also be found in the the Original Data Folder

Combines lists: 
List of orphan medicinal products in Europe with European orphan designation and European marketing
authorization
Annex 1: Orphan medicinal products withdrawn from the European Community Register of orphan
medicinal products 23
Annex 2: Orphan medicinal products withdrawn from use in the European Union 

```{r}
eu_orphan_drugs <- read_xlsx("Cleaned Data/Area Level Orphan Authorizations/EU_Orphan_w_Company from https___www.orpha.net_orphacom_cahiers_docs_GB_list_of_orphan_drugs_in_europe.xlsx")
eu_orphan_drugs <- clean_names(eu_orphan_drugs)
eu_orphan_drugs
```

Check for duplicated rows

```{r}
eu_orphan_drugs[duplicated(eu_orphan_drugs),]

```

Number of MAs per company in EU

```{r}
eu_company_freq <- eu_orphan_drugs %>%
  count(firm) %>%
  arrange(desc(n))
colnames(eu_company_freq) <- c("Firm", "Market Authorization Count")
eu_company_freq
```

EU number of market authorizations for each drug 

```{r}
eu_ma_freq <- eu_orphan_drugs %>%
  count(tradename) %>%
  arrange(desc(n))

colnames(eu_ma_freq) <- c("Generic Name", "Market Authorizations")
eu_ma_freq$`Generic Name` <- tolower(eu_ma_freq$`Generic Name`)
eu_ma_freq

```

How many ODs with more than 1 authorization in EU

```{r}
nrow(eu_ma_freq[eu_ma_freq$`Market Authorizations` > 1, ])
```


```{r}
eu_ma_freq[eu_ma_freq$`Market Authorizations` > 1, ]
```


```{r}
stargazer(eu_ma_freq[1:9,], title= "EU Market Authorization Counts for Orphan Drugs with Over 1 Market Authorization", rownames = FALSE, align=TRUE, summary=FALSE, type = "html", out="Final Figures Formatted/EU_OD_Multiple_MAs.htm")

```

Look at some instances where there are multiple market authorizations for the same drug

```{r}
eu_orphan_drugs[eu_orphan_drugs$tradename == "GLIVEC",]
eu_orphan_drugs[eu_orphan_drugs$tradename == "NEXAVAR",]
eu_orphan_drugs[eu_orphan_drugs$tradename == "REVLIMID",]
eu_orphan_drugs[eu_orphan_drugs$tradename == "CARBAGLU",]
eu_orphan_drugs[eu_orphan_drugs$tradename == "SOLIRIS",]

```

Select only new drugs in the EU

```{r}
eu_orphan_drugs_new <- eu_orphan_drugs %>%
  group_by(tradename) %>%  
  slice_min(order_by = market_authorization_year, n = 1, with_ties = FALSE) %>%  # Select the entry with the earliest market authorization year
  ungroup() 

eu_orphan_drugs_new
```

count new EU orphan drug market authorizations by year

```{r}
eu_new_od_ma_freqs <- as.data.frame(table(eu_orphan_drugs_new$market_authorization_year))
colnames(eu_new_od_ma_freqs) <- c("Year", "Freq New Orphan Drug MAs")
eu_new_od_ma_freqs

eu_new_od_ma_freqs$Year <- as.character(eu_new_od_ma_freqs$Year)
eu_new_od_ma_freqs$Year <- as.numeric(eu_new_od_ma_freqs$Year)
eu_new_od_ma_freqs <- eu_new_od_ma_freqs[order(-eu_new_od_ma_freqs$Year),] 

head(eu_new_od_ma_freqs)
```

Select all MAs in the EU

format EU market authorizations by year

```{r}
eu_od_ma_freqs <- as.data.frame(table(eu_orphan_drugs$market_authorization_year))
colnames(eu_od_ma_freqs) <- c("Year", "Freq Orphan Drug MAs")
eu_od_ma_freqs

eu_od_ma_freqs$Year <- as.character(eu_od_ma_freqs$Year)
eu_od_ma_freqs$Year <- as.numeric(eu_od_ma_freqs$Year)
eu_od_ma_freqs <- eu_od_ma_freqs[order(-eu_od_ma_freqs$Year),] 
head(eu_od_ma_freqs)

eu_od_ma_freqs <- merge(eu_od_ma_freqs, eu_new_od_ma_freqs, by = "Year")
eu_od_ma_freqs
```

Graph of EU Market Authorized orphan drugs

```{r}

eu_od_ma_freqs_2003 <- eu_od_ma_freqs <- eu_od_ma_freqs[eu_od_ma_freqs$Year > 2003,]

ggplot(eu_od_ma_freqs_2003, aes(x = Year)) +
  geom_line(aes(y = `Freq Orphan Drug MAs`, color="All Orphan Drug MAs")) +
  geom_line(aes(y = `Freq New Orphan Drug MAs`, color="MAs for New Orphan Drugs")) +
  labs(x = "Year",
       y = "Number of Market Authorizations in the EU",
       title="Annual Number of Orphan Drug Market Authorizations in the EU"
       ) +
  scale_color_manual(name = " ", values = c("lightskyblue3", "darkred"))+
  theme_minimal()
```

merge orphan drug and R&D spending tables for EU

```{r}
colnames(efpia_rd_totals) <- c("Year", "total_rd_euros", "total_rd_mil_dollars" , "total_rd_bil_dollars")
eu_rd_mas <- merge(efpia_rd_totals,eu_od_ma_freqs,by="Year")
eu_rd_mas <- clean_names(eu_rd_mas)
eu_rd_mas
```

# PhRMA/ United States

## PhRMA R&D spending by year

<https://phrma.org/-/media/Project/PhRMA/PhRMA-Org/PhRMA-Refresh/Report-PDFs/P-R/PhRMA_membership-survey_2022_final.pdf>

```{r}
phrma_us_rd <- read.csv("Cleaned Data/Area Level R&D Spending/US Domestic R&D and R&D Abroad,* PhRMA Member Companies- 1983–2021 (dollar figures in millions) .csv")
head(phrma_us_rd,20)
```

## US orphan drug Market Authorizations

<https://www.accessdata.fda.gov/scripts/opdlisting/oopd/> Only approved
products

```{r}
us_orphan_drugs <- read.csv("Original Data/Area Level Orphan Authorizations/US_FDA_OD.csv")

us_orphan_drugs <- clean_names(us_orphan_drugs)
us_orphan_drugs <- us_orphan_drugs[!is.na(us_orphan_drugs$marketing_approval_date), ] 
us_orphan_drugs

tail(us_orphan_drugs, n=5)
us_orphan_drugs <- head(us_orphan_drugs[order(us_orphan_drugs$marketing_approval_date),],-2) #notes removed at bottom of df

us_orphan_drugs$marketing_approval_date <- as.Date(us_orphan_drugs$marketing_approval_date, format="%m/%d/%y")

us_orphan_drugs <- us_orphan_drugs[order(us_orphan_drugs$marketing_approval_date),]
us_orphan_drugs

```

Check for duplicated rows. Remove one row because duplicated

```{r}
us_orphan_drugs[duplicated(us_orphan_drugs),]                     # see if rows are duplicated
us_orphan_drugs[us_orphan_drugs$generic_name == "tacrolimus" ,]   # view the duplication
us_orphan_drugs[710, ]                                            #see what row number are duplicated row is in 
us_orphan_drugs <- us_orphan_drugs[-710, ]                       #remove duplicated row
us_orphan_drugs[duplicated(us_orphan_drugs),]                    #ensure we removed duplicated row

```

US Number of MAs per company

```{r}
us_company_freq <- us_orphan_drugs %>%
  count(sponsor_company) %>%
  arrange(desc(n))
colnames(us_company_freq) <- c("Sponsor Company", "Market Authorizations")
us_company_freq
```

US Number of market authorizations per drug

```{r}
us_ma_freq <- us_orphan_drugs %>%
  count(generic_name) %>%
  arrange(desc(n))
colnames(us_ma_freq) <- c("Generic Name", "Market Authorizations")

us_ma_freq
```

How many ODs with more than 1 authorization in US

```{r}
nrow(us_ma_freq[us_ma_freq$`Market Authorizations` > 1, ])
```

How many ODs with more than 5 authorizations in US
```{r}
nrow(us_ma_freq[us_ma_freq$`Market Authorizations` > 5, ])
```


```{r}
us_ma_freq[us_ma_freq$`Market Authorizations` > 5, ]
```

```{r}
stargazer(us_ma_freq[1:19,], title= "US Market Authorization Counts for Orphan Drugs with Over 5 Market Authorizations", rownames = FALSE, align=TRUE, summary=FALSE, type = "html", out="Final Figures Formatted/US_OD_Multiple_MAs.htm")

```


Look at some instances where there are multiple market authorizations for the same drug

```{r}
us_orphan_drugs[us_orphan_drugs$generic_name == "nivolumab",]
us_orphan_drugs[us_orphan_drugs$generic_name == "pembrolizumab",]
us_orphan_drugs[us_orphan_drugs$generic_name == "bevacizumab",]

```

Select only new drugs in the US

```{r}
us_orphan_drugs_new <- us_orphan_drugs %>%
  group_by(generic_name) %>%  
  slice_min(order_by = marketing_approval_date, n = 1, with_ties = FALSE) %>%  # Select the entry with the earliest market authorization year
  ungroup() 

us_orphan_drugs_new

```

```{r}
us_orphan_drugs_new$Marketing.year <- year(as.Date(us_orphan_drugs_new$marketing_approval_date)) 
us_new_od_ma_freqs <- as.data.frame(table(us_orphan_drugs_new$Marketing.year))
colnames(us_new_od_ma_freqs) <- c("Year", "Freq New Orphan Drug MAs")
us_new_od_ma_freqs
```


Select all MAs in the US. Format US MA date as year

```{r}
us_orphan_drugs$Marketing.year <- year(as.Date(us_orphan_drugs$marketing_approval_date)) 
us_od_ma_freqs <- as.data.frame(table(us_orphan_drugs$Marketing.year))
colnames(us_od_ma_freqs) <- c("Year", "Freq Orphan Drug MAs")

us_od_ma_freqs$Year <- as.character(us_od_ma_freqs$Year)
us_od_ma_freqs$Year <- as.numeric(us_od_ma_freqs$Year)
us_od_ma_freqs <- us_od_ma_freqs[order(-us_od_ma_freqs$Year),] 

us_od_ma_freqs <- merge(us_od_ma_freqs, us_new_od_ma_freqs, by = "Year")

us_od_ma_freqs
```

Graph of US Market Authorizations orphan drugs

```{r}

us_od_ma_freqs_2003 <- us_od_ma_freqs[us_od_ma_freqs$Year > 2003,]
us_od_ma_freqs_2003_2022 <- us_od_ma_freqs[us_od_ma_freqs_2003$Year < 2022,]

ggplot(us_od_ma_freqs, aes(x = Year)) +
  geom_line(aes(y = `Freq Orphan Drug MAs`, color="All Orphan Drug MAs")) +
  geom_line(aes(y = `Freq New Orphan Drug MAs`, color="MAs for New Orphan Drugs")) +
  labs(x = "Year",
       y = str_wrap("Number of Market Authorizations in the US", width=60),
       title=str_wrap("Annual Number of Orphan Drug Market Authorizations in the US", width=60), 
       ) +
  scale_color_manual(name = " ", values = c("lightskyblue3", "darkred"))+
  theme_minimal()
```

merge US orphan drug df with PhRMA r&d df

```{r}
phrma_us_rd <- phrma_us_rd[-dim(phrma_us_rd)[1],] # last row is NA
us_rd_mas <- merge(phrma_us_rd,us_od_ma_freqs,by="Year")
us_rd_mas
```

format

```{r}
us_rd_mas$Domestic.R.D. <- parse_number(us_rd_mas$Domestic.R.D.) #dollars are in millions
us_rd_mas <- clean_names(us_rd_mas)
us_rd_mas
```

us dataframe simplified

```{r}
us_rd_mas$annual_domestic_RD_spending_bil_dollars <- us_rd_mas$domestic_r_d /1000 #convert from millions of dollars to billions
us_rd_mas_simplified <- as.data.frame(cbind(us_rd_mas$year, us_rd_mas$annual_domestic_RD_spending_bil_dollars, us_rd_mas$freq_orphan_drug_m_as, us_rd_mas$freq_new_orphan_drug_m_as))

colnames(us_rd_mas_simplified) <- c("year", "annual_domestic_RD_spending_bil_dollars", "freq_orphan_drug_mas", "freq_new_orphan_drug_mas")

us_rd_mas_simplified$area <- rep("US", dim(us_rd_mas_simplified)[1]) # write US indicator in area column

us_rd_mas_simplified$lagged_annual_domestic_RD_spending_bil_dollars <- lag(us_rd_mas_simplified$annual_domestic_RD_spending_bil_dollars)

us_rd_mas_simplified
```

eu dataframe simplified

```{r}
eu_rd_mas_simplified <- as.data.frame(cbind(eu_rd_mas$year, eu_rd_mas$total_rd_bil_dollars, eu_rd_mas$freq_orphan_drug_m_as, eu_rd_mas$freq_new_orphan_drug_m_as))

colnames(eu_rd_mas_simplified) <- c("year", "annual_domestic_RD_spending_bil_dollars", "freq_orphan_drug_mas", "freq_new_orphan_drug_mas")

eu_rd_mas_simplified$area <- rep("EU", dim(eu_rd_mas_simplified)[1]) # write EU indicator in area column

eu_rd_mas_simplified$lagged_annual_domestic_RD_spending_bil_dollars <- lag(eu_rd_mas_simplified$annual_domestic_RD_spending_bil_dollars) # for lagged R&D spending - not used

eu_rd_mas_simplified
```

# EU GDP Per Capita In Dollars

<https://www.macrotrends.net/global-metrics/countries/EUU/european-union/gdp-per-capita>

```{r}
eu_gdp_percapita_annual <- read.csv("Original Data/GDP/european-union-gdp-per-capita-annual.csv", skip=16)
eu_gdp_percapita_annual$year <- year(as.Date(eu_gdp_percapita_annual$date))
eu_gdp_percapita_annual <- clean_names(eu_gdp_percapita_annual)
colnames(eu_gdp_percapita_annual)[2] <- "gdp_per_capita_usd"
colnames(eu_gdp_percapita_annual)[3] <- "gdp_per_capita_annual_growthrate_usd"
eu_gdp_percapita_annual
```


# EU GDP (Billion USD)
<https://www.macrotrends.net/global-metrics/countries/EUU/european-union/gdp-gross-domestic-product>
EU GDP per capita is measured in billions of dollars and the growth rate is taken from those measurements

```{r}
us_gdp_annual <- read.csv("Original Data/GDP/european-union-gdp-gross-domestic-product.csv", skip=8)
us_gdp_annual <- us_gdp_annual[c(24:64),c(1:4)]
us_gdp_annual$year <- year(as.Date(us_gdp_annual$Date, format="%m/%d/%y"))
us_gdp_annual
us_gdp_annual <- clean_names(us_gdp_annual)
colnames(us_gdp_annual)[2] <- "gdp_billions_of_usd"

us_gdp_annual

```

Merge GDP Per Capita, GDP Growth rate into same df

```{r}
eu_rd_mas_simplified <- merge(eu_rd_mas_simplified, eu_gdp_percapita_annual[,c("year", "gdp_per_capita_annual_growthrate_usd")], by = "year", all.x = TRUE)
eu_rd_mas_simplified <- merge(eu_rd_mas_simplified, us_gdp_annual[,c("year", "gdp_billions_of_usd")], by = "year", all.x = TRUE)

eu_rd_mas_simplified
```



# US GDP Per Capita In Dollars

<https://www.macrotrends.net/global-metrics/countries/USA/united-states/gdp-per-capita>

```{r}
us_gdp_percapita_annual <- read.csv("Original Data/GDP/united-states-gdp-per-capita-annual.csv", skip=16)
us_gdp_percapita_annual$year <- year(as.Date(us_gdp_percapita_annual$date))

us_gdp_percapita_annual <- clean_names(us_gdp_percapita_annual)
colnames(us_gdp_percapita_annual)[2] <- "gdp_per_capita_usd"
colnames(us_gdp_percapita_annual)[3] <- "gdp_per_capita_annual_growthrate_usd"

us_gdp_percapita_annual

```


# US GDP (Billion USD)
https://www.macrotrends.net/global-metrics/countries/usa/united-states/gdp-gross-domestic-product#:~:text=U.S.%20gdp%20for%202023%20was,a%200.92%25%20decline%20from%202019. 
```{r}
us_gdp_annual <- read.csv("Original Data/GDP/united-states-gdp-gross-domestic-product.csv", skip=8)
us_gdp_annual <- us_gdp_annual[c(24:64),c(1:4)]
us_gdp_annual$year <- year(as.Date(us_gdp_annual$Date, format="%m/%d/%y"))

us_gdp_annual <- clean_names(us_gdp_annual)
colnames(us_gdp_annual)[2] <- "gdp_billions_of_usd"

us_gdp_annual

```

Merge GDP Per Capita, GDP Growth rate into same df

```{r}
us_rd_mas_simplified <- merge(us_rd_mas_simplified, us_gdp_percapita_annual[,c("year", "gdp_per_capita_annual_growthrate_usd")], by = "year", all.x = TRUE)
us_rd_mas_simplified <- merge(us_rd_mas_simplified, us_gdp_annual[,c("year", "gdp_billions_of_usd")], by = "year", all.x = TRUE)
us_rd_mas_simplified
```

Limit dataframe to 2004 and later, make lagged R&D spending NA at year 2004

```{r}
combined_rd_ma_df <- rbind(eu_rd_mas_simplified, us_rd_mas_simplified)
combined_rd_ma_df <- combined_rd_ma_df %>%
  filter(year > 2003)
combined_rd_ma_df[combined_rd_ma_df$area =="US" & combined_rd_ma_df$year==2004,]$lagged_annual_domestic_RD_spending_bil_dollars <-  NA
combined_rd_ma_df
```


```{r}

ggplot(combined_rd_ma_df, aes(x = annual_domestic_RD_spending_bil_dollars, y = freq_orphan_drug_mas, color = area)) +
  geom_point() +
  labs(x = "Annual Domestic RD Spending (Billions USD)",
       y = "Number of Orphan Drug Market Authorizations",
       color = "Region",
       title=str_wrap("Orphan Drug Market Authorizations by Annual Domestic R&D Spending in the EU and US", 60)) +
  scale_color_manual(name = "Region", values = c('US' = 'darkblue', 'EU' = '#E66100')) +
  theme_minimal()
```

```{r}
ggplot(combined_rd_ma_df, aes(x = year , y = freq_orphan_drug_mas, color = area)) +
  geom_line() +
  labs(x = "Year",
       y = "Number of Orphan Drug Market Authorizations", width=30,
       color = "Region",
       title=str_wrap("Annual Number of Orphan Drug Market Authorizations in the EU and US", width=70)) +
    theme_minimal() +
    scale_color_manual(name = "Region", values = c('US' = 'darkblue', 'EU' = '#E66100'))
```

```{r}

ggplot(combined_rd_ma_df, aes(x = year , y = freq_new_orphan_drug_mas, color = area)) +
  geom_line() +
  labs(x = "Year",
       y = str_wrap("Number of Market Authorizations for New Orphan Drugs", width=40),
       color = "Region",
       title=str_wrap("Annual Number of Market Authorizations for New Orphan Drugs in the EU and US", width=60)) +
    theme_minimal() +
    scale_color_manual(name = "Region", values = c('US' = 'darkblue', 'EU' = '#E66100')) 
```

```{r}
ggplot(combined_rd_ma_df, aes(x = year, y = annual_domestic_RD_spending_bil_dollars, color = area)) +
  geom_line() +
  labs(x = "Year",
       y = "Domestic R&D Spending (Billions USD)",
       color = "Region",
       title="Annual Domestic R&D Spending in the EU and US") +
    scale_color_manual(name = "Region", values = c('US' = 'darkblue', 'EU' = '#E66100')) +
  theme_minimal()
```


```{r}
ggplot(combined_rd_ma_df, aes(x = year, y = gdp_billions_of_usd, color = area)) +
  geom_line() +
  labs(x = "Year",
       y = "GDP (Billions USD)",
       color = "Region",
       title="GDP in the EU and US") +
    scale_color_manual(name = "Region", values = c('US' = 'darkblue', 'EU' = '#E66100')) +
  theme_minimal()
```


```{r}
ggplot(combined_rd_ma_df, aes(x = year, y = gdp_per_capita_annual_growthrate_usd, color = area)) +
  geom_line() +
  labs(x = "Year",
       y = "GDP Per Capita on Last Day of Year (USD)",
       color = "Region",
       title="GDP Per Capita on Last Day of Year in the EU and US") +
    scale_color_manual(name = "Region", values = c('US' = 'darkblue', 'EU' = '#E66100')) +
  theme_minimal()
```

```{r}
combined_rd_ma_df
```


```{r}
ggplot(combined_rd_ma_df, aes(x = year, y = annual_domestic_RD_spending_bil_dollars/gdp_billions_of_usd, color = area)) +
  geom_line() +
  labs(x = "Year",
       y = "Domestic R&D Spending / GDP",
       color = "Region",
       title=str_wrap("Annual Domestic Pharmaceutical R&D Spending as a Fraction of GDP in the EU and US", width=50))  +
    scale_color_manual(name = "Region", values = c('US' = 'darkblue', 'EU' = '#E66100')) +
  theme_minimal()
```


```{r}
ggplot(combined_rd_ma_df, aes(x = annual_domestic_RD_spending_bil_dollars, y = freq_orphan_drug_mas, color = area)) +
  geom_point() +
  labs(x = "Domestic R&D Spending (Billions USD)",
       y = "Number of Orphan Drug Market Authorizations",
       color = "Region",
       title=str_wrap("Annual Number of Orphan Drug Market Authorizations by Domestic R&D Spending in the EU and US", width=50)) +
    scale_color_manual(name = "Region", values = c('US' = 'darkblue', 'EU' = '#E66100')) +
  theme_minimal()
```

```{r}
ggplot(combined_rd_ma_df, aes(x = annual_domestic_RD_spending_bil_dollars, y = freq_new_orphan_drug_mas, color = area)) +
  geom_point() +
  labs(x = "Domestic R&D Spending",
       y = "Number of MAs for New Orphan Drugs",
       color = "Region",
       title="MAs for new Orphan Drugs by Domestic R&D Spending in the EU and US") +
    scale_color_manual(name = "Region", values = c('US' = 'darkblue', 'EU' = '#E66100')) +
  theme_minimal()
```

Orphan Drug Frequencies by Year by Area

```{r}
hist(subset(combined_rd_ma_df, area=="US")$freq_orphan_drug_mas, main="US Frequencies of Annual Orphan Drug Market Authorizations", xlab="Number of Annual US Orphan Drug Market Authorizations")
hist(subset(combined_rd_ma_df, area=="EU")$freq_orphan_drug_mas, main="EU Frequencies of Annual Orphan Drug Market Authorizations",xlab="Number of Annual EU Orphan Drug Market Authorizations")
```

New Orphan Drugs Frequencies by Year by Area

```{r}
hist(subset(combined_rd_ma_df, area=="US")$freq_new_orphan_drug_mas, main="US Frequencies of Annual New Orphan Drug Market Authorizations", xlab="Number of Annual US Orphan Drug Market Authorizations")
hist(subset(combined_rd_ma_df, area=="EU")$freq_new_orphan_drug_mas, main="EU Frequencies of Annual New Orphan Drug Market Authorizations",xlab="Number of Annual EU Orphan Drug Market Authorizations")
```

# Making a years after 2004 variable

```{r}
combined_rd_ma_df$yearsafter2004 <- combined_rd_ma_df$year - 2004
combined_rd_ma_df
```



### VIFs & Correlations of preditors

Models to find VIFs
```{r}
mod.rd.vif.check.rd <- lm(annual_domestic_RD_spending_bil_dollars ~  as.factor(area) + yearsafter2004 +  gdp_per_capita_annual_growthrate_usd, data=combined_rd_ma_df)
vif(mod.rd.vif.check.rd)
```

```{r}
mod.rd.vif.check.od <- lm(freq_orphan_drug_mas ~  as.factor(area) + yearsafter2004 +  gdp_per_capita_annual_growthrate_usd + annual_domestic_RD_spending_bil_dollars, data=combined_rd_ma_df)
vif(mod.rd.vif.check.od)
```


Correlation Matrix
```{r}
cor(combined_rd_ma_df[, c("annual_domestic_RD_spending_bil_dollars",
                          "yearsafter2004",
                          "gdp_per_capita_annual_growthrate_usd"
  
)])
  
```


# Summmaries

R&D spending growth rates by year

```{r}
rdspending <- combined_rd_ma_df[combined_rd_ma_df$area == "EU", ]$annual_domestic_RD_spending_bil_dollars 
laggedrdspending <- combined_rd_ma_df[combined_rd_ma_df$area == "EU", ]$lagged_annual_domestic_RD_spending_bil_dollars 
EU_annual_domestic_RD_spending_bil_dollars_growth_rate <- rdspending/laggedrdspending
EU_annual_domestic_RD_spending_bil_dollars_growth_rate


rdspending <- combined_rd_ma_df[combined_rd_ma_df$area == "US", ]$annual_domestic_RD_spending_bil_dollars 
laggedrdspending <- combined_rd_ma_df[combined_rd_ma_df$area == "US", ]$lagged_annual_domestic_RD_spending_bil_dollars 
US_annual_domestic_RD_spending_bil_dollars_growth_rate <- rdspending/laggedrdspending
US_annual_domestic_RD_spending_bil_dollars_growth_rate
```

```{r}
rdspending_growth_rates <- data.frame("Year"=seq(2004,2021), "US"=round(US_annual_domestic_RD_spending_bil_dollars_growth_rate,2), "EU"=round(EU_annual_domestic_RD_spending_bil_dollars_growth_rate,2))

rdspending_growth_rates$US <- as.character(rdspending_growth_rates$US )
rdspending_growth_rates$EU <- as.character(rdspending_growth_rates$EU )

# make 2011 NA because 2011 values were imputed 
rdspending_growth_rates[rdspending_growth_rates$Year == 2011,]$EU <- "NA"
rdspending_growth_rates[rdspending_growth_rates$Year == 2012,]$EU <- "NA"

rdspending_growth_rates

```

```{r}
stargazer(rdspending_growth_rates,  out="Final Figures Formatted/RDSpendingAnnualGrowthRates.htm" , summary=FALSE, rownames=FALSE, colnames = TRUE, digits=2, digit.separator="",column.sep.width= "15pt", title="Annual Growth Rate of Phramaceutical R&D Spending")
```



# Linear Models of Annual Domestic R&D Spending

Function to Plot Linear Models of Annual Domestic R&D Spending
```{r}
plot_linear_rd <- function(linear_model, model_number){
  
  #Plot residuals and acf/ pacf of residuals by panel (EU/US)
  combined_rd_ma_df$residuals <- resid(linear_model)
  par(mfrow=c(2,3))
  
  us_resid_data <- combined_rd_ma_df[combined_rd_ma_df$area == "US",]
  eu_resid_data <- combined_rd_ma_df[combined_rd_ma_df$area == "EU",]
  
  plot(us_resid_data$year, us_resid_data$residuals, xlab="Year", main="US Residuals", ylab="Residuals")
  acf(us_resid_data$residuals, main="ACF of US Residuals")
  pacf(us_resid_data$residuals, main="PACF of US Residuals")
  #qqnorm(us_resid_data$residuals, main = "QQ Plot of US Residuals")
  
  plot(eu_resid_data$year, eu_resid_data$residuals, xlab="Year", main="EU Residuals", ylab="Residuals")
  acf(eu_resid_data$residuals, main="ACF of EU Residuals")
  pacf(eu_resid_data$residuals, main="PACF of EU Residuals")
  #qqnorm(eu_resid_data$residuals, main = "QQ Plot of EU Residuals")
  
  mtext(glue('Linear Model {model_number} of Domestic R&D Spending - Residual Plots'), side = 3, line = -1.1, outer = TRUE)

  predicted <- predict(linear_model , type = "response")

  ggplot(combined_rd_ma_df, aes(x = year, y = annual_domestic_RD_spending_bil_dollars, color = area, alpha="Observed")) +
    geom_point() +
    labs(x = "Year",
         y = "Domestic R&D Spending (Billions USD)",
         alpha = "",
         color = "Region",
         title=glue('Linear Model {model_number} of Annual Domestic R&D Spending'))+
    geom_line(aes(x=year, y=predicted, alpha = "Fitted"))+
    scale_alpha_manual(values = c(0.5, 1), guide = guide_legend(order = 1))+
    scale_color_manual(name = "Region", values = c('US' = 'darkblue', 'EU' = '#E66100')) +
  theme_minimal()
    
  # https://aosmith.rbind.io/2020/07/09/ggplot2-override-aes/
  #Controlling legend appearance in ggplot2 with override.aes
  #July 9, 2020 ·  @aosmith16 
  #Ariel Muldoon
  
  # https://www.tidyverse.org/blog/2024/02/ggplot2-3-5-0-legends/
  # Teun van den Brand
  # 2024/02/26

}
```

Function to Get Model Metrics of Linear Models of Annual Domestic R&D Spending
```{r}

get_rd_model_metrics <- function(model, model_type){
  
  #Get RMSE
  predicted <- predict(model, type = "response")
  actual <- combined_rd_ma_df$annual_domestic_RD_spending_bil_dollars
  model_rmse <- Metrics::rmse(actual=actual, predicted=predicted)
  
  #Get F stat & pvalue
  model_fstat <- summary(model)$fstatistic[1]
  model_df1 <- summary(model)$fstatistic[2]
  model_df2 <- summary(model)$fstatistic[3]
  model_pval <- pf(model_fstat, model_df1, model_df2, lower.tail = FALSE) 
  # https://www.reneshbedre.com/blog/get-f-stat-p-value-from-lm.html
  # Renesh Bedre
  # March 26, 2023
    
  # Get Adj Rsq and AIC
  model_adjRsq <- summary(model)$adj.r.squared
  model_aic <- AIC(model)
  
  #List metrics in a df
  metrics_df <- data.frame("rmse" = model_rmse, "aic"= model_aic, "df1" = model_df1, "df2" = model_df2, "fstat" = model_fstat, "pval" = model_pval, "adjrsq" = model_adjRsq)
  rownames(metrics_df) <- NULL

  return(metrics_df)
}

```

## Linear Model 1 of Annual Domestic R&D Spending

```{r}
mod.rd.1 <- lm(annual_domestic_RD_spending_bil_dollars ~  as.factor(area) , data=combined_rd_ma_df)
summary(mod.rd.1)

plot_linear_rd(mod.rd.1, "1")

#Estimate covariance matrix with Newey West
mod.rd.1.vcov <- vcovPL(mod.rd.1, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994") 

#Adjust standard errors based on estimated covariance matrix
mod.rd.nw.1 <- coeftest(mod.rd.1, vcov = mod.rd.1.vcov) 
mod.rd.nw.1

confint(mod.rd.nw.1)

#Get Metrics
mod.rd.1.metrics <- get_rd_model_metrics(mod.rd.1, "Linear")
mod.rd.1.metrics
```

## Linear Model 2 of Annual Domestic R&D Spending

```{r}
mod.rd.2 <- lm(annual_domestic_RD_spending_bil_dollars ~  as.factor(area) + yearsafter2004, data=combined_rd_ma_df)
summary(mod.rd.2)

plot_linear_rd(mod.rd.2, "2")

#Estimate covariance matrix with Newey West
mod.rd.2.vcov <- vcovPL(mod.rd.2, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994") 

#Adjust standard errors based on estimated covariance matrix
mod.rd.nw.2 <- coeftest(mod.rd.2, vcov = mod.rd.2.vcov) 
mod.rd.nw.2

confint(mod.rd.nw.2)

#Get Metrics
mod.rd.2.metrics <- get_rd_model_metrics(mod.rd.2, "Linear")
mod.rd.2.metrics
```

## Linear Model 3 of Annual Domestic R&D Spending

```{r}
mod.rd.3 <- lm(annual_domestic_RD_spending_bil_dollars ~  as.factor(area) + yearsafter2004 + gdp_per_capita_annual_growthrate_usd, data=combined_rd_ma_df)
summary(mod.rd.3)

plot_linear_rd(mod.rd.3, "3")

#Estimate covariance matrix with Newey West
mod.rd.3.vcov <- vcovPL(mod.rd.3, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")

#Adjust standard errors based on estimated covariance matrix
mod.rd.nw.3 <- coeftest(mod.rd.3, vcov = mod.rd.3.vcov)
mod.rd.nw.3

confint(mod.rd.nw.3, level=0.9)

#Get Metrics
mod.rd.3.metrics <- get_rd_model_metrics(mod.rd.3, "Linear")
mod.rd.3.metrics
```


## Linear Model 4 of Annual Domestic R&D Spending

```{r}
mod.rd.4 <- lm(annual_domestic_RD_spending_bil_dollars ~  as.factor(area) + yearsafter2004 + as.factor(area):yearsafter2004 , data=combined_rd_ma_df)
summary(mod.rd.4)

plot_linear_rd(mod.rd.4, "4")

#Estimate covariance matrix with Newey West
mod.rd.4.vcov <- vcovPL(mod.rd.4, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994") 

#Adjust standard errors based on estimated covariance matrix
mod.rd.nw.4 <- coeftest(mod.rd.4, vcov = mod.rd.4.vcov) 
mod.rd.nw.4

confint(mod.rd.nw.4)

#Get Metrics
mod.rd.4.metrics <- get_rd_model_metrics(mod.rd.4, "Linear")
mod.rd.4.metrics
```

## Linear Model 5 of Annual Domestic R&D Spending

```{r}
mod.rd.5 <- lm(annual_domestic_RD_spending_bil_dollars ~  as.factor(area) + yearsafter2004 + yearsafter2004:as.factor(area) + gdp_per_capita_annual_growthrate_usd, data=combined_rd_ma_df)
summary(mod.rd.5)

plot_linear_rd(mod.rd.5, "5")

#Estimate covariance matrix with Newey West
mod.rd.5.vcov <- vcovPL(mod.rd.5, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.rd.nw.5 <- coeftest(mod.rd.5, vcov = mod.rd.5.vcov)
mod.rd.nw.5

confint(mod.rd.nw.5)

#Get Metrics
mod.rd.5.metrics <- get_rd_model_metrics(mod.rd.5, "Linear")
mod.rd.5.metrics
```

## Linear Model 6 of Annual Domestic R&D Spending

```{r}
mod.rd.6 <- lm(annual_domestic_RD_spending_bil_dollars ~  as.factor(area) + yearsafter2004 + yearsafter2004:as.factor(area) + I(yearsafter2004^2) + I(yearsafter2004^2):as.factor(area) +  gdp_per_capita_annual_growthrate_usd, data=combined_rd_ma_df)
summary(mod.rd.6)

plot_linear_rd(mod.rd.6, "6")

#Estimate covariance matrix with Newey West
mod.rd.6.vcov <- vcovPL(mod.rd.6, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.rd.nw.6 <- coeftest(mod.rd.6, vcov = mod.rd.6.vcov)
mod.rd.nw.6

confint(mod.rd.nw.6)

#Get Metrics
mod.rd.6.metrics <- get_rd_model_metrics(mod.rd.6, "Linear")
mod.rd.6.metrics
```





```{r}
mod.rd.metrics <- rbind(mod.rd.1.metrics, mod.rd.2.metrics, mod.rd.3.metrics, mod.rd.4.metrics, mod.rd.5.metrics, mod.rd.6.metrics)

aic_values <- round(mod.rd.metrics$aic)
rmse_values <- round(mod.rd.metrics$rmse, 2)
fstat_values <- round(mod.rd.metrics$fstat, 2)
p_values <- round(mod.rd.metrics$pval, 4)
adjrsq_values <- round(mod.rd.metrics$adjrsq, 2)

stargazer(mod.rd.1, mod.rd.2, mod.rd.3, mod.rd.4, mod.rd.5, mod.rd.6, 
          title="Linear Models of Annual Domestic Pharmaceutical R&D Spending (Not Adjusted for Error Structure)", align=TRUE, type = "html", out="Final Models Formatted/rdmodelsNonAdjusted.htm",
          covariate.labels = c("US", "Years After 2004", "Years After 2004^{2}","Annual GDP Growth Rate Per Capita", "US:Years After 2004", "US:Years After 2004^{2}", "Intercept"),
          dep.var.labels=c("Annual Domestic Pharmaceutical R&D Spending (Billion USD)"),
          column.labels=c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5", "Model 6"),
          model.numbers=FALSE,
          omit.stat = c("all"),
          add.lines = list(c("AIC", aic_values), c("RMSE", rmse_values), c("Adj R^{2}", adjrsq_values), c("F Statistic", fstat_values), c("p-value", p_values)))
```

 
```{r}

#creating shorter names because stargazer has a length limit for the input of all models
m1 <- mod.rd.nw.1 
m2 <- mod.rd.nw.2 
m3 <- mod.rd.nw.3
m4 <- mod.rd.nw.4
m5 <- mod.rd.nw.5 
m6 <- mod.rd.nw.6

stargazer(m1, m2, m3, m4, m5, m6, title="Newey-West Adjusted Linear Models of Annual Domestic Pharmaceutical R&D Spending", align=TRUE, type = "html", out="Final Models Formatted/rdmodels.htm",
          covariate.labels = c("US", "Years After 2004", "Years After 2004^{2}","Annual GDP Growth Rate Per Capita", "US:Years After 2004", "US:Years After 2004^{2}", "Intercept"),
          dep.var.labels=c("Annual Domestic Pharmaceutical R&D Spending (Billion USD)"),
          column.labels=c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5", "Model 6"),
          omit.stat = c("all"),
          model.numbers=FALSE,
          add.lines = list(c("AIC", aic_values), c("RMSE", rmse_values), c("Adj R^{2}", adjrsq_values), c("F Statistic", fstat_values), c("p-value", p_values)))
```

# Linear Models of Number of Orphan Drug Market Authorizations

Function to Plot Models of Number of Orphan Drug Market Authorizations (Linear or
Poisson Models)

```{r}
plot_lin_pois_od <- function(model, model_number, model_type){
  
  #Plot residuals and acf/ pacf of residuals by panel (EU/US)
  combined_rd_ma_df$residuals <- resid(model)
  par(mfrow =c(2,3))
  
  us_resid_data <- combined_rd_ma_df[combined_rd_ma_df$area == "US",]
  eu_resid_data <- combined_rd_ma_df[combined_rd_ma_df$area == "EU",]
  
  plot(us_resid_data$year, us_resid_data$residuals, xlab="Year", main="US Residuals", ylab="Residuals")
  acf(us_resid_data$residuals, main="ACF of US Residuals")
  pacf(us_resid_data$residuals, main="PACF of US Residuals")
  #qqnorm(us_resid_data$residuals, main = "QQ Plot of US Residuals")
  
  plot(eu_resid_data$year, eu_resid_data$residuals, xlab="Year", main="EU Residuals", ylab="Residuals")
  acf(eu_resid_data$residuals, main="ACF of EU Residuals")
  pacf(eu_resid_data$residuals, main="PACF of EU Residuals")
  #qqnorm(eu_resid_data$residuals, main = "QQ Plot of EU Residuals")
  
  
  mtext(glue('{model_type} Model {model_number} of Orphan Drug MAs - Residual Plots'), side = 3, line = -1.1, outer = TRUE)

  predicted <- predict(model , type = "response")
  
  ggplot(combined_rd_ma_df, aes(x = year, y = freq_orphan_drug_mas, color = area, alpha="Observed")) +
    geom_point() +
    labs(x = "Year",
         y = str_wrap("Number of Orphan Drug Market Authorizations", width = 40),
         color = "Region",
         alpha = " ",
         title=str_wrap(glue("{model_type} Model {model_number} of Annual Orphan Drug Market Authorizations"), width = 60))+
    scale_color_manual(name = "Region", values = c('US' = 'darkblue', 'EU' = '#E66100')) +
    geom_line(aes(x=year, y=predicted, alpha = "Fitted"))+
    scale_alpha_manual(values = c(0.5, 1))+
  theme_minimal()
    
  # https://aosmith.rbind.io/2020/07/09/ggplot2-override-aes/
  #Controlling legend appearance in ggplot2 with override.aes
  #July 9, 2020 ·  @aosmith16 
  
  # https://www.tidyverse.org/blog/2024/02/ggplot2-3-5-0-legends/
  #Teun van den Brand
  #2024/02/26

}
```

Get Metrics of Models of Number of Orphan Drug Market Authorizations
(Linear or Poisson Models)

```{r}

get_od_model_metrics <- function(model, model_type){
  
  #Get RMSE
  predicted <- predict(model, type = "response")
  actual <- combined_rd_ma_df$freq_orphan_drug_mas
  model_rmse <- Metrics::rmse(actual=actual, predicted=predicted)
  

  model_df1 <- NA
  model_df2 <- NA
  model_adjRsq <- NA
  model_fstat <- NA
  model_pval <- NA
  model_loglik <- NA
  
  if(model_type == "Linear"){
    model_df1 <- summary(model)$fstatistic[2]
    model_df2 <- summary(model)$fstatistic[3]
    model_fstat <- summary(model)$fstatistic[1]
    model_pval <- pf(model_fstat, model_df1, model_df2, lower.tail = FALSE) 
    # https://www.reneshbedre.com/blog/get-f-stat-p-value-from-lm.html
    # Renesh Bedre
    # March 26, 2023
    model_adjRsq <- summary(model)$adj.r.squared
  }
  
  if(model_type == "Poisson"){
    model_loglik <- logLik(model)
  }
  
  model_aic <- AIC(model)
  
  metrics_df <- data.frame("rmse" = model_rmse, "aic"= model_aic, "df1" = model_df1, "df2" = model_df2, "fstat" = model_fstat, "pval" = model_pval, "adjrsq" = model_adjRsq, "LogLik" = model_loglik)
  rownames(metrics_df) <- NULL


  return(metrics_df)
}
```




## Linear Model 1 of Num of Annual Orphan Drug MAs

```{r}
mod.od.1 <- lm(freq_orphan_drug_mas ~ as.factor(area), data=combined_rd_ma_df)
summary(mod.od.1)

plot_lin_pois_od(mod.od.1, "1", "Linear")

#Estimate covariance matrix with Newey West
mod.od.1.vcov <- vcovPL(mod.od.1, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994") 

#Adjust standard errors based on estimated covariance matrix
mod.od.nw.1 <-coeftest(mod.od.1, vcov = mod.od.1.vcov)
mod.od.nw.1

confint(mod.od.nw.1)
mod.od.1.metrics <- get_od_model_metrics(mod.od.1, "Linear")
```




## Linear Model 2 of Num of Annual Orphan Drug MAs

```{r}
mod.od.2 <- lm(freq_orphan_drug_mas ~ as.factor(area) + yearsafter2004, data=combined_rd_ma_df)
summary(mod.od.2)

plot_lin_pois_od(mod.od.2, "2", "Linear")

#Estimate covariance matrix with Newey West
mod.od.2.vcov <- vcovPL(mod.od.2, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994") 

#Adjust standard errors based on estimated covariance matrix
mod.od.nw.2 <-coeftest(mod.od.2, vcov = mod.od.2.vcov)
mod.od.nw.2

confint(mod.od.nw.2)
mod.od.2.metrics <- get_od_model_metrics(mod.od.2, "Linear")

```




## Linear Model 3 of Num of Annual Orphan Drug MAs

```{r}
mod.od.3 <- lm(freq_orphan_drug_mas ~ as.factor(area) + yearsafter2004 + gdp_per_capita_annual_growthrate_usd, data=combined_rd_ma_df)
summary(mod.od.3)

plot_lin_pois_od(mod.od.3, "3", "Linear")

#Estimate covariance matrix with Newey West
mod.od.3.vcov <- vcovPL(mod.od.3, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.od.nw.3 <-coeftest(mod.od.3, vcov = mod.od.3.vcov)
mod.od.nw.3

confint(mod.od.nw.3)
mod.od.3.metrics <- get_od_model_metrics(mod.od.3, "Linear")

```


```{r}
vif(mod.od.3)
```


## Linear Model 4 of Num of Annual Orphan Drug MAs

```{r}
mod.od.4 <- lm(freq_orphan_drug_mas ~ as.factor(area) + yearsafter2004 + as.factor(area):yearsafter2004, data=combined_rd_ma_df)
summary(mod.od.4)

plot_lin_pois_od(mod.od.4, "4", "Linear")

#Estimate covariance matrix with Newey West
mod.od.4.vcov <- vcovPL(mod.od.4, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994") 

#Adjust standard errors based on estimated covariance matrix
mod.od.nw.4 <-coeftest(mod.od.4, vcov = mod.od.4.vcov)
mod.od.nw.4

confint(mod.od.nw.4)
mod.od.4.metrics <- get_od_model_metrics(mod.od.4, "Linear")

predicted <- predict(mod.od.4, type = "response")


```


## Linear Model 5 of Num of Annual Orphan Drug MAs

```{r}
mod.od.5 <- lm(freq_orphan_drug_mas ~ as.factor(area) + yearsafter2004 + yearsafter2004:as.factor(area) + gdp_per_capita_annual_growthrate_usd, data=combined_rd_ma_df)
summary(mod.od.5)

plot_lin_pois_od(mod.od.5, "5", "Linear")

#Estimate covariance matrix with Newey West
mod.od.5.vcov <- vcovPL(mod.od.5, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.od.nw.5 <-coeftest(mod.od.5, vcov = mod.od.5.vcov)
mod.od.nw.5

confint(mod.od.nw.5)
mod.od.5.metrics <- get_od_model_metrics(mod.od.5, "Linear")

predicted <- predict(mod.od.5, type = "response")


```



```{r}
mod.od.metrics <- rbind(mod.od.1.metrics, mod.od.2.metrics, mod.od.3.metrics, mod.od.4.metrics, mod.od.5.metrics)
aic_values <- round(mod.od.metrics$aic)
rmse_values <- round(mod.od.metrics$rmse, 2)
fstat_values <- round(mod.od.metrics$fstat, 2)
p_values <- round(mod.od.metrics$pval, 4)
adjrsq_values <- round(mod.od.metrics$adjrsq, 2)


stargazer(mod.od.1, mod.od.2, mod.od.3, mod.od.4, mod.od.5, title="Linear Models of Orphan Drug Market Authorizations (Not Adjusted for Error Structure)", align=TRUE, type = "html", out="Final Models Formatted/orphandrugMAmodelsNonAdjusted.htm",
          covariate.labels = c("US", "Years After 2004", "Annual GDP Growth Rate Per Capita", "Years After 2004:US", "Intercept"),
          dep.var.labels=c("Annual Number of Orphan Drug Market Authorizations"),
          column.labels=c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
          model.numbers=FALSE,
          omit.stat = c("all"),
          add.lines = list(c("AIC", aic_values), c("RMSE", rmse_values), c("Adj R^{2}", adjrsq_values), c("F Statistic", fstat_values), c("p-value", p_values)))
```

```{r}
#creating shorter names because stargazer has a length limit for the input of all models

m1 <- mod.od.nw.1
m2 <- mod.od.nw.2
m3 <- mod.od.nw.3
m4 <- mod.od.nw.4
m5 <- mod.od.nw.5 

stargazer(m1,m2,m3,m4,m5, title="Newey-West Adjusted Linear Models of Orphan Drug Market Authorizations", align=TRUE, type = "html", out="Final Models Formatted/orphandrugMAmodels.htm",
          covariate.labels = c("US", "Years After 2004", "Annual GDP Growth Rate Per Capita", "Years After 2004:US", "Intercept"),
          dep.var.labels=c("Annual Number of Orphan Drug Market Authorizations"),
          column.labels=c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
          model.numbers=FALSE,
          omit.stat = c("all"),
          add.lines = list(c("AIC", aic_values), c("RMSE", rmse_values), c("Adj R^{2}", adjrsq_values), c("F Statistic", fstat_values), c("p-value", p_values)))
```





# Poisson Models of Number of Orphan Drug Market Authorization Models

## Poisson Model 1 of Num of Annual Orphan Drug MAs

Newey-West adjustment for glms with panel data: 
Zeileis, Achim, and Thomas Lumley. Package “Sandwich” Title Robust Covariance Matrix Estimators. 15 Sept. 2020, pp. 4–6, cran.r-project.org/web/packages/sandwich/sandwich.pdf.

Aghion P, Van Reenen J, Zingales L (2013). “Innovation and Institutional Ownership.” The American Economic Review, 103(1), 277–304. doi:10.1257/aer.103.1.277
https://www.aeaweb.org/articles?id=10.1257/aer.103.1.277


```{r}
mod.pois.od.1 <- glm(freq_orphan_drug_mas ~ as.factor(area), data=combined_rd_ma_df, family=poisson(link="log"))
summary(mod.pois.od.1)

plot_lin_pois_od(mod.pois.od.1, "1", "Poisson")

#Estimate covariance matrix with Newey West
mod.pois.od.1.vcov <- vcovPL(mod.pois.od.1, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.pois.od.nw.1 <- coeftest(mod.pois.od.1, vcov = mod.pois.od.1.vcov)
mod.pois.od.nw.1

confint(mod.pois.od.nw.1)
mod.pois.od.1.metrics <- get_od_model_metrics(mod.pois.od.1, "Poisson")
mod.pois.od.1.metrics
```

## Poisson Model 2 of Num of Annual Orphan Drug MAs

```{r}
mod.pois.od.2 <- glm(freq_orphan_drug_mas ~ as.factor(area) + yearsafter2004, data=combined_rd_ma_df, family=poisson(link="log"))
summary(mod.pois.od.2)

plot_lin_pois_od(mod.pois.od.2, "2", "Poisson")

#Estimate covariance matrix with Newey West
mod.pois.od.2.vcov <- vcovPL(mod.pois.od.2, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.pois.od.nw.2 <- coeftest(mod.pois.od.2, vcov = mod.pois.od.2.vcov)
mod.pois.od.nw.2

confint(mod.pois.od.nw.2)
mod.pois.od.2.metrics <- get_od_model_metrics(mod.pois.od.2, "Poisson")
mod.pois.od.2.metrics

```



## Poisson Model 3 of Num of Annual Orphan Drug MAs

```{r}
mod.pois.od.3 <- glm(freq_orphan_drug_mas ~ as.factor(area) + yearsafter2004 + gdp_per_capita_annual_growthrate_usd, data=combined_rd_ma_df, family=poisson(link="log"))
summary(mod.pois.od.3)

plot_lin_pois_od(mod.pois.od.3, "3", "Poisson")

#Estimate covariance matrix with Newey West
mod.pois.od.3.vcov <- vcovPL(mod.pois.od.3, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.pois.od.nw.3 <- coeftest(mod.pois.od.3, vcov = mod.pois.od.3.vcov)
mod.pois.od.nw.3

confint(mod.pois.od.nw.3)
mod.pois.od.3.metrics <- get_od_model_metrics(mod.pois.od.3, "Poisson")
mod.pois.od.3.metrics
```


## Poisson Model 4 of Num of Annual Orphan Drug MAs

```{r}
mod.pois.od.4 <- glm(freq_orphan_drug_mas ~ as.factor(area) + yearsafter2004 + as.factor(area):yearsafter2004, data=combined_rd_ma_df, family=poisson(link="log"))
summary(mod.pois.od.4)

plot_lin_pois_od(mod.pois.od.4, "4", "Poisson")

#Estimate covariance matrix with Newey West
mod.pois.od.4.vcov <- vcovPL(mod.pois.od.4, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.pois.od.nw.4 <- coeftest(mod.pois.od.4, vcov = mod.pois.od.4.vcov)
mod.pois.od.nw.4

confint(mod.pois.od.nw.4)
mod.pois.od.4.metrics <- get_od_model_metrics(mod.pois.od.4, "Poisson")
mod.pois.od.4.metrics
```



## Poisson Model 5 of Num of Annual Orphan Drug MAs

```{r}
mod.pois.od.5 <- glm(freq_orphan_drug_mas ~ as.factor(area) + yearsafter2004 + yearsafter2004:as.factor(area) + gdp_per_capita_annual_growthrate_usd , data=combined_rd_ma_df, family=poisson(link="log")) 
summary(mod.pois.od.5)

plot_lin_pois_od(mod.pois.od.5, "5", "Poisson")

#Estimate covariance matrix with Newey West
mod.pois.od.5.vcov <- vcovPL(mod.pois.od.5, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.pois.od.nw.5 <- coeftest(mod.pois.od.5, vcov = mod.pois.od.5.vcov)
mod.pois.od.nw.5

confint(mod.pois.od.nw.5)
mod.pois.od.5.metrics <- get_od_model_metrics(mod.pois.od.5, "Poisson")

```



```{r}

mod.od.pois.metrics <- rbind(mod.pois.od.1.metrics, mod.pois.od.2.metrics, mod.pois.od.3.metrics, mod.pois.od.4.metrics, mod.pois.od.5.metrics)
mod.od.pois.metrics
```

```{r}

mod.od.pois.metrics <- rbind(mod.pois.od.1.metrics, mod.pois.od.2.metrics, mod.pois.od.3.metrics, mod.pois.od.4.metrics, mod.pois.od.5.metrics)

aic_values <- round(mod.od.pois.metrics$aic)
rmse_values <- round(mod.od.pois.metrics$rmse, 2)
logLik_vlues <- round(mod.od.pois.metrics$LogLik, 2)


#creating shorter names because stargazer has a length limit for the input of all models

m1 <- mod.pois.od.1
m2 <- mod.pois.od.2
m3 <- mod.pois.od.3
m4 <- mod.pois.od.4
m5 <- mod.pois.od.5 


stargazer(m1, m2, m3, m4, m5, title="Poisson Models of Annual Orphan Drug Market Authorizations (Not adjusted for Error Structure)", align=TRUE, type = "html", out="Final Models Formatted/PoissonorphandrugMAmodelsNonAdjusted.htm",
          covariate.labels = c("US", "Years After 2004", "Annual GDP Growth Rate Per Capita", "Years After 2004:US", "Intercept"),
          dep.var.labels=c("Annual Number of Orphan Drug Market Authorizations"),
          column.labels=c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
          model.numbers=FALSE,
          omit.stat = c("all"),
          add.lines = list(c("AIC", aic_values), c("RMSE", rmse_values), c("Log Likelihood", logLik_vlues)))

```

```{r}
#creating shorter names because stargazer has a length limit for the input of all models

m1 <- mod.pois.od.nw.1
m2 <- mod.pois.od.nw.2
m3 <- mod.pois.od.nw.3
m4 <- mod.pois.od.nw.4
m5 <- mod.pois.od.nw.5 

stargazer(m1,m2,m3,m4,m5, title="Newey-West Adjusted Poisson Models of Orphan Drug Market Authorizations", align=TRUE, type = "html", out="Final Models Formatted/PoissonorphandrugMAmodels.htm",
          covariate.labels = c("US", "Years After 2004", "Annual GDP Growth Rate Per Capita", "Years After 2004:US", "Intercept"),
          dep.var.labels=c("Annual Number of Orphan Drug Market Authorizations"),
          column.labels=c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
          model.numbers=FALSE,
          omit.stat = c("all"),
          add.lines = list(c("AIC", aic_values), c("RMSE", rmse_values), c("Log Likelihood", logLik_vlues)))
```

# Linear Models of Number of Market Authorizations for NEW Orphan Drugs

Plot Models of Number of Orphan Drug Market Authorizations for NEW
Orphan Drugs (Linear or Poisson Models)

```{r}
plot_lin_pois_new_od <- function(model, model_number, model_type){
  
  #Plot residuals and acf/ pacf of residuals by panel (EU/US)
  combined_rd_ma_df$residuals <- resid(model)
  
  par(mfrow =c(2,3))
  
  us_resid_data <- combined_rd_ma_df[combined_rd_ma_df$area == "US",]
  eu_resid_data <- combined_rd_ma_df[combined_rd_ma_df$area == "EU",]
  
  plot(us_resid_data$year, us_resid_data$residuals, xlab="Year", main="US Residuals", ylab="Residuals")
  acf(us_resid_data$residuals, main="ACF of US Residuals")
  pacf(us_resid_data$residuals, main="PACF of US Residuals")
  #qqnorm(us_resid_data$residuals, main = "QQ Plot of US Residuals")
  
  plot(eu_resid_data$year, eu_resid_data$residuals, xlab="Year", main="EU Residuals", ylab="Residuals")
  acf(eu_resid_data$residuals, main="ACF of EU Residuals")
  pacf(eu_resid_data$residuals, main="PACF of EU Residuals")
  #qqnorm(eu_resid_data$residuals, main = "QQ Plot of EU Residuals")
  
  mtext(glue('{model_type} Model {model_number} of MAs for New Orphan Drugs - Residual Plots'), side = 3, line = -1.1, outer = TRUE)

  predicted <- predict(model , type = "response")
  
  ggplot(combined_rd_ma_df, aes(x = year, y = freq_new_orphan_drug_mas, color = area, alpha="Observed")) +
    geom_point() +
    labs(x = "Year",
         y = str_wrap("Number of Market Authorizations for New Orphan Drugs", width = 40),
         color = "Region",
         alpha = " ",
         title=str_wrap(glue("{model_type} Model {model_number} of Market Authorizations for New Orphan Drugs"), width = 60))+
    scale_color_manual(name = "Region", values = c('US' = 'darkblue', 'EU' = '#E66100')) +
    geom_line(aes(x=year, y=predicted, alpha = "Fitted"))+
    scale_alpha_manual(values = c(0.5, 1))+
  theme_minimal()
    
  # https://aosmith.rbind.io/2020/07/09/ggplot2-override-aes/
  #Controlling legend appearance in ggplot2 with override.aes
  #July 9, 2020 ·  @aosmith16 
  
  # https://www.tidyverse.org/blog/2024/02/ggplot2-3-5-0-legends/
  #Teun van den Brand
  #2024/02/26

}
```

Get Metrics of Models of Number of Market Authorizations for NEW Orphan
Drugs (Linear or Poisson Models)

```{r}

get_new_od_model_metrics <- function(model, model_type){
  #Get RMSE
  predicted <- predict(model, type = "response")
  actual <- combined_rd_ma_df$freq_new_orphan_drug_mas
  model_rmse <- Metrics::rmse(actual=actual, predicted=predicted)
  
  model_df1 <- NA
  model_df2 <- NA
  model_adjRsq <- NA
  model_fstat <- NA
  model_pval <- NA
  model_loglik <- NA
  
  if(model_type == "Linear"){
    
    model_df1 <- summary(model)$fstatistic[2]
    model_df2 <- summary(model)$fstatistic[3]
    model_fstat <- summary(model)$fstatistic[1]
    model_pval <- pf(model_fstat, model_df1, model_df2, lower.tail = FALSE) 
    # https://www.reneshbedre.com/blog/get-f-stat-p-value-from-lm.html
    # Renesh Bedre
    # March 26, 2023
  
    model_adjRsq <- summary(model)$adj.r.squared
  }
  
  if(model_type == "Poisson"){
    model_loglik <- logLik(model)
  }
  
  model_aic <- AIC(model)
  
  metrics_df <- data.frame("rmse" = model_rmse, "aic"= model_aic, "df1" = model_df1, "df2" = model_df2, "fstat" = model_fstat, "pval" = model_pval, "adjrsq" = model_adjRsq, "LogLik" = model_loglik)
  rownames(metrics_df) <- NULL


  return(metrics_df)
}
```


## Linear Model 1 of Annual MAs for NEW orphan drugs

```{r}
mod.new.od.1 <- lm(freq_new_orphan_drug_mas ~ as.factor(area), data=combined_rd_ma_df)
summary(mod.new.od.1)

plot_lin_pois_new_od(mod.new.od.1, "1", "Linear")

#Estimate covariance matrix with Newey West
mod.new.od.1.vcov <- vcovPL(mod.new.od.1, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.new.od.nw.1 <-coeftest(mod.new.od.1, vcov = mod.new.od.1.vcov)
mod.new.od.nw.1

mod.new.od.1.metrics <- get_new_od_model_metrics(mod.new.od.1, "Linear")
confint(mod.new.od.nw.1)
```

## Linear Model 2 of Annual MAs for NEW orphan drugs

```{r}
mod.new.od.2 <- lm(freq_new_orphan_drug_mas ~ as.factor(area) + yearsafter2004, data=combined_rd_ma_df)
summary(mod.new.od.2)

plot_lin_pois_new_od(mod.new.od.2, "2", "Linear")

#Estimate covariance matrix with Newey West
mod.new.od.2.vcov <- vcovPL(mod.new.od.2, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.new.od.nw.2 <-coeftest(mod.new.od.2, vcov = mod.new.od.2.vcov)
mod.new.od.nw.2

mod.new.od.2.metrics <- get_new_od_model_metrics(mod.new.od.2, "Linear")

```



## Linear Model 3 of Annual MAs for NEW orphan drugs

```{r}
mod.new.od.3 <- lm(freq_new_orphan_drug_mas ~ as.factor(area) + yearsafter2004 + gdp_per_capita_annual_growthrate_usd, data=combined_rd_ma_df)
summary(mod.new.od.3)

plot_lin_pois_new_od(mod.new.od.3, "3", "Linear")

#Estimate covariance matrix with Newey West
mod.new.od.3.vcov <- vcovPL(mod.new.od.3, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.new.od.nw.3 <-coeftest(mod.new.od.3, vcov = mod.new.od.3.vcov)
mod.new.od.nw.3

mod.new.od.3.metrics <- get_new_od_model_metrics(mod.new.od.3, "Linear")

confint(mod.new.od.nw.3)
```

## Linear Model 4 of Annual MAs for NEW orphan drugs

```{r}
mod.new.od.4 <- lm(freq_new_orphan_drug_mas ~ as.factor(area) + yearsafter2004 + as.factor(area):yearsafter2004, data=combined_rd_ma_df)
summary(mod.new.od.4)

plot_lin_pois_new_od(mod.new.od.4, "4", "Linear")

#Estimate covariance matrix with Newey West
mod.new.od.4.vcov <- vcovPL(mod.new.od.4, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.new.od.nw.4 <-coeftest(mod.new.od.4, vcov = mod.new.od.4.vcov)
mod.new.od.nw.4

mod.new.od.4.metrics <- get_new_od_model_metrics(mod.new.od.4, "Linear")

confint(mod.new.od.nw.4)

predicted <- predict(mod.new.od.4, type = "response")

# Plot of Annual Orphan Drug Market Authorizations by R&D spending
ggplot(combined_rd_ma_df, aes(x = annual_domestic_RD_spending_bil_dollars, y = freq_new_orphan_drug_mas, color = area, alpha="Observed")) +
  geom_point() +
  labs(x = "Domestic R&D Spending (Billion USD)",
       y = str_wrap("Number of Market Authorizations for New Orphan Drugs", width = 40),
       color = "Region",
       alpha = "",
       title=str_wrap(glue("Linear Model 4 of Market Authorizations for New Orphan Drugs by Domestic R&D Spending"), width = 60))+
  scale_color_manual(name = "Region", values = c('US' = 'darkblue', 'EU' = '#E66100')) +
  geom_line(aes(x=annual_domestic_RD_spending_bil_dollars, y=predicted, alpha = "Fitted"))+
  scale_alpha_manual(values = c(0.5, 1))
theme_minimal()

```

## Linear Model 5 of Annual MAs for NEW orphan drugs

```{r}
mod.new.od.5 <- lm(freq_new_orphan_drug_mas ~ as.factor(area) + yearsafter2004 + yearsafter2004:as.factor(area) + gdp_per_capita_annual_growthrate_usd, data=combined_rd_ma_df)
summary(mod.new.od.5)

plot_lin_pois_new_od(mod.new.od.5, "5", "Linear")

#Estimate covariance matrix with Newey West
mod.new.od.5.vcov <- vcovPL(mod.new.od.5, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.new.od.nw.5 <-coeftest(mod.new.od.5, vcov = mod.new.od.5.vcov)
mod.new.od.nw.5

mod.new.od.5.metrics <- get_new_od_model_metrics(mod.new.od.5, "Linear")

confint(mod.new.od.nw.5)

predicted <- predict(mod.new.od.5, type = "response")

# Plot of Annual Orphan Drug Market Authorizations by R&D spending
ggplot(combined_rd_ma_df, aes(x = annual_domestic_RD_spending_bil_dollars, y = freq_new_orphan_drug_mas, color = area, alpha="Observed")) +
  geom_point() +
  labs(x = "Domestic R&D Spending (Billion USD)",
       y = str_wrap("Number of Market Authorizations for New Orphan Drugs", width = 40),
       color = "Region",
       alpha = "",
       title=str_wrap(glue("Linear Model 5 of Market Authorizations for New Orphan Drugs by Domestic R&D Spending"), width = 60))+
  scale_color_manual(name = "Region", values = c('US' = 'darkblue', 'EU' = '#E66100')) +
  geom_line(aes(x=annual_domestic_RD_spending_bil_dollars, y=predicted, alpha = "Fitted"))+
  scale_alpha_manual(values = c(0.5, 1))+
theme_minimal()
    

```


```{r}
mod.new.od.metrics <- rbind(mod.new.od.1.metrics, mod.new.od.2.metrics, mod.new.od.3.metrics, mod.new.od.4.metrics, mod.new.od.5.metrics)
aic_values <- round(mod.new.od.metrics$aic)
rmse_values <- round(mod.new.od.metrics$rmse, 2)
fstat_values <- round(mod.new.od.metrics$fstat, 2)
p_values <- round(mod.new.od.metrics$pval, 4)
adjrsq_values <- round(mod.new.od.metrics$adjrsq, 2)

#creating shorter names because stargazer has a length limit for the input of all models

m1 <- mod.new.od.1
m2 <- mod.new.od.2
m3 <- mod.new.od.3
m4 <- mod.new.od.4
m5 <- mod.new.od.5 

stargazer(m1, m2, m3, m4, m5, title="Linear Models of Market Authorizations for New Orphan Drugs (Not adjusted for Error Structure)", align=TRUE, type = "html", out="Final Models Formatted/NEWorphandrugMAmodelsNonAdjusted.htm",
          covariate.labels = c("US", "Years After 2004", "Annual GDP Growth Rate Per Capita", "Years After 2004:US", "Intercept"),
          dep.var.labels=c("Annual Number of Market Authorizations for New Orphan Drugs"),
          column.labels=c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
          model.numbers=FALSE,
          omit.stat = c("all"),
          add.lines = list(c("AIC", aic_values), c("RMSE", rmse_values), c("Adj R^{2}", adjrsq_values), c("F Statistic", fstat_values), c("p-value", p_values)))

```

```{r}
#creating shorter names because stargazer has a length limit for the input of all models

m1 <- mod.new.od.nw.1
m2 <- mod.new.od.nw.2
m3 <- mod.new.od.nw.3
m4 <- mod.new.od.nw.4
m5 <- mod.new.od.nw.5 


stargazer(m1, m2, m3, m4, m5, title="Newey-West Adjusted Linear Models of Market Authorizations for New Orphan Drugs", align=TRUE, type = "html", out="Final Models Formatted/NEWorphandrugMAmodels.htm",
          covariate.labels = c("US", "Years After 2004", "Annual GDP Growth Rate Per Capita", "Years After 2004:US", "Intercept"),
          dep.var.labels=c("Annual Number of Market Authorizations for New Orphan Drugs"),
          column.labels=c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
          model.numbers=FALSE,
          omit.stat = c("all"),
          add.lines = list(c("AIC", aic_values), c("RMSE", rmse_values), c("Adj R^{2}", adjrsq_values), c("F Statistic", fstat_values), c("p-value", p_values)))

```

Overall mean of Domestic R&D spending

```{r}
mean(combined_rd_ma_df$annual_domestic_RD_spending_bil_dollars)
```

Overall mean of US Domestic R&D spending

```{r}
mean(subset(combined_rd_ma_df ,area=="US")$annual_domestic_RD_spending_bil_dollars)
```

Overall mean of annual EU Domestic R&D spending

```{r}
mean(subset(combined_rd_ma_df ,area=="EU")$annual_domestic_RD_spending_bil_dollars)
```

Overall mean of annual number of US Market Authroized Orphan Drugs

```{r}
mean(subset(combined_rd_ma_df ,area=="US")$freq_orphan_drug_mas)
mean(subset(combined_rd_ma_df ,area=="US")$freq_new_orphan_drug_mas)
```

Overall mean of annual number of EU Market Authroized Orphan Drugs

```{r}
mean(subset(combined_rd_ma_df ,area=="EU")$freq_orphan_drug_mas)
mean(subset(combined_rd_ma_df ,area=="EU")$freq_new_orphan_drug_mas)

```

# Poisson Models for Number of Market Authorizations for NEW Orphan Drugs


## Poisson model 1 of Annual Num of MAs for NEW orphan drugs

```{r}
mod.pois.new.od.1 <- glm(freq_new_orphan_drug_mas ~ as.factor(area), data=combined_rd_ma_df, family=poisson(link="log"))
summary(mod.pois.new.od.1)

plot_lin_pois_new_od(mod.pois.new.od.1, "1", "Poisson")

#Estimate covariance matrix with Newey West
mod.pois.new.od.1.vcov <- vcovPL(mod.pois.new.od.1, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.pois.new.od.nw.1 <- coeftest(mod.pois.new.od.1, vcov = mod.pois.new.od.1.vcov)
mod.pois.new.od.nw.1

mod.pois.new.od.1.metrics <- get_new_od_model_metrics(mod.pois.new.od.1, "Poisson")
mod.pois.new.od.1.metrics

confint(mod.pois.new.od.nw.1)
```

## Poisson model 2 of Annual Num of MAs for NEW orphan drugs

```{r}
mod.pois.new.od.2 <- glm(freq_new_orphan_drug_mas ~ as.factor(area) + yearsafter2004, data=combined_rd_ma_df, family=poisson(link="log"))
summary(mod.pois.new.od.2)

plot_lin_pois_new_od(mod.pois.new.od.2, "2", "Poisson")

#Estimate covariance matrix with Newey West
mod.pois.new.od.2.vcov <- vcovPL(mod.pois.new.od.2, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.pois.new.od.nw.2 <- coeftest(mod.pois.new.od.2, vcov = mod.pois.new.od.2.vcov)
mod.pois.new.od.nw.2

mod.pois.new.od.2.metrics <- get_new_od_model_metrics(mod.pois.new.od.2, "Poisson")
mod.pois.new.od.2.metrics

confint(mod.pois.new.od.nw.2)
```


## Poisson model 3 of Annual Num of MAs for NEW orphan drugs

```{r}
mod.pois.new.od.3 <- glm(freq_new_orphan_drug_mas ~ as.factor(area) + yearsafter2004 + gdp_per_capita_annual_growthrate_usd, data=combined_rd_ma_df, family=poisson(link="log"))
summary(mod.pois.new.od.3)

plot_lin_pois_new_od(mod.pois.new.od.3, "3", "Poisson")

#Estimate covariance matrix with Newey West
mod.pois.new.od.3.vcov <- vcovPL(mod.pois.new.od.3, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.pois.new.od.nw.3 <- coeftest(mod.pois.new.od.3, vcov = mod.pois.new.od.3.vcov)
mod.pois.new.od.nw.3

mod.pois.new.od.3.metrics <- get_new_od_model_metrics(mod.pois.new.od.3, "Poisson")
mod.pois.new.od.3.metrics

confint(mod.pois.new.od.nw.3)
```


## Poisson model 4 of Annual Num of MAs for NEW orphan drugs

```{r}
mod.pois.new.od.4 <- glm(freq_new_orphan_drug_mas ~ as.factor(area) + yearsafter2004 + as.factor(area):yearsafter2004, data=combined_rd_ma_df, family=poisson(link="log")) 
summary(mod.pois.new.od.4)

plot_lin_pois_new_od(mod.pois.new.od.4, "4", "Poisson")

#Estimate covariance matrix with Newey West
mod.pois.new.od.4.vcov <- vcovPL(mod.pois.new.od.4, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.pois.new.od.nw.4 <- coeftest(mod.pois.new.od.4, vcov = mod.pois.new.od.4.vcov)
mod.pois.new.od.nw.4

mod.pois.new.od.4.metrics <- get_new_od_model_metrics(mod.pois.new.od.4, "Poisson")
mod.pois.new.od.4.metrics

confint(mod.pois.new.od.nw.4)

  
```

## Poisson model 5 of Annual Num of MAs for NEW orphan drugs

```{r}
mod.pois.new.od.5 <- glm(freq_new_orphan_drug_mas ~ as.factor(area) + yearsafter2004 + yearsafter2004:as.factor(area) + gdp_per_capita_annual_growthrate_usd, data=combined_rd_ma_df, family=poisson(link="log")) 
summary(mod.pois.new.od.5)

plot_lin_pois_new_od(mod.pois.new.od.5, "5", "Poisson")

#Estimate covariance matrix with Newey West
mod.pois.new.od.5.vcov <- vcovPL(mod.pois.new.od.5, cluster = ~ as.factor(combined_rd_ma_df$area), lag="NW1994")  

#Adjust standard errors based on estimated covariance matrix
mod.pois.new.od.nw.5 <- coeftest(mod.pois.new.od.5, vcov = mod.pois.new.od.5.vcov)
mod.pois.new.od.nw.5

mod.pois.new.od.5.metrics <- get_new_od_model_metrics(mod.pois.new.od.5, "Poisson")
mod.pois.new.od.5.metrics

confint(mod.pois.new.od.nw.5)


```


```{r}

mod.pois.new.od.metrics <- rbind(mod.pois.new.od.1.metrics, mod.pois.new.od.2.metrics, mod.pois.new.od.3.metrics, mod.pois.new.od.4.metrics, mod.pois.new.od.5.metrics)
aic_values <- round(mod.pois.new.od.metrics$aic)
rmse_values <- round(mod.pois.new.od.metrics$rmse, 2)
loglik_values <- round(mod.pois.new.od.metrics$LogLik, 2)

#creating shorter names because stargazer has a length limit for the input of all models

m1 <- mod.pois.new.od.1
m2 <- mod.pois.new.od.2
m3 <- mod.pois.new.od.3
m4 <- mod.pois.new.od.4
m5 <- mod.pois.new.od.5 

stargazer(m1, m2, m3, m4, m5, title="Poisson Models of Annual Market Authorizations for New Orphan Drugs (Not adjusted for Error Structure)", align=TRUE, type = "html", out="Final Models Formatted/PoissonNEWorphandrugMAmodelsNonAdjusted.htm",
          covariate.labels = c("US", "Years After 2004", "Annual GDP Growth Rate Per Capita", "Years After 2004:US", "Intercept"),
          dep.var.labels=c("Annual Number of Market Authorizations for New Orphan Drugs"),
          column.labels=c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
          model.numbers=FALSE,
          omit.stat = c("all"),
          add.lines = list(c("AIC", aic_values), c("RMSE", rmse_values), c("Log Likelihood", loglik_values)))

```

```{r}
#creating shorter names because stargazer has a length limit for the input of all models

m1 <- mod.pois.new.od.nw.1
m2 <- mod.pois.new.od.nw.2
m3 <- mod.pois.new.od.nw.3
m4 <- mod.pois.new.od.nw.4
m5 <- mod.pois.new.od.nw.5 

stargazer(m1,m2,m3,m4,m5, title="Newey-West Adjusted Poisson Models of Annual Market Authorizations for New Orphan Drugs ", align=TRUE, type = "html", out="Final Models Formatted/PoissonNEWorphandrugMAmodels.htm",
          covariate.labels = c("US", "Years After 2004", "Annual GDP Growth Rate Per Capita", "Years After 2004:US", "Intercept"),
          dep.var.labels=c("Annual Number of Market Authorizations for New Orphan Drugs"),
          column.labels=c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
          model.numbers=FALSE,
          omit.stat = c("all"),
          add.lines = list(c("AIC", aic_values), c("RMSE", rmse_values), c("Log Likelihood", loglik_values)))
```







```{r}
combined_rd_ma_df
```






