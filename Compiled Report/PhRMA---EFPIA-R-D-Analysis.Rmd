---
title: "PhRMA & EFPIA R&D Analysis"
author: "Bena Smith"
output:
  html_document:
    
    df_print: paged
  pdf_document:
      extra_dependencies: 
        dcolumn: null
---

    includes:
      in_header: preamble.tex
      
```{r}
library(ggplot2)
library(plm)
library(lmtest)
library(sandwich)
library(janitor)
library(dplyr)
library(readxl)
library(writexl)
library(lubridate)
library(readr)
library(nlme)
library(stringr)
library(broom)
library(tidyr)
library(stargazer)
library(PerformanceAnalytics)

```


# Data Cleaning

## US Orphan drugs from https://drugdatabase.info/orphan-designations-approvals/
```{r}
orphandrugs_FDA <- read.csv("/Users/benasmith/Desktop/Research Proj/Pharma Proj/Compiled Report/Original Data/Area Level Orphan Authorizations/FDA Orphan Designations (updated January 7, 2022) https___drugdatabase.info_orphan-designations-approvals_ .xlsx - All Designations.csv")
```


Get only drugs that have marketing approval
```{r}
#orphandrugs_FDA <- orphandrugs_FDA[!grepl("N/A", orphandrugs_FDA$Marketing.Approval.Date),]
orphandrugs_FDA <- na.omit(orphandrugs_FDA, cols = "Marketing.Approval.Date")

filtered_orphandrugs_FDA <- orphandrugs_FDA %>%
  filter(!is.na(Marketing.Approval.Date) & grepl("^[12]", Marketing.Approval.Date)) ##get where market approval date starts with a 1 or 2

```

Write US Orphan Drugs to xlsx Cleaned Data File
```{r}
filtered_orphandrugs_FDA[order(orphandrugs_FDA$Trade.Name),]

```

```{r}
writexl::write_xlsx(filtered_orphandrugs_FDA, "/Users/benasmith/Desktop/Research Proj/Pharma Proj/Compiled Report/Cleaned Data/Area Level Orphan Authorizations/US_Approved_and_MarketApproved_OrphanDrugs.xlsx")
```


```{r}
orphandrugs_FDA <- read.csv("~/Desktop/Research Proj/Pharma Proj/Compiled Report/Original Data/Area Level Orphan Authorizations/US_FDA_OD.csv")
orphandrugs_FDA <- clean_names(orphandrugs_FDA)
orphandrugs_FDA[order(orphandrugs_FDA$trade_name),]

```




## EU Orphan Drugs were scraped from a pdf https://www.orpha.net/pdfs/orphacom/cahiers/docs/GB/list_of_orphan_drugs_in_europe.pdf it can be found in the the Original Data Folder


# EFPIA r&d spending by country by year in euros
From yearly pdf reports 
2004: **LINK NEEDED**
2005: https://www.efpia.eu/media/15485/the-pharmaceutical-industry-in-figures-edition-2007.pdf
2006: https://www.efpia.eu/media/15486/the-pharmaceutical-industry-in-figures-edition-2008.pdf
2007: https://www.pharmine.eu/wp-content/uploads/2014/04/The_Pharma_Industry_in_figures_Edition_2009-20080612-009-EN-v1.pdf
2008: https://www.sfee.gr/wp-content/uploads/2015/05/Figures_2010_Final-20100611-001-EN-v1_0.pdf
2009: https://www.efpia.eu/media/15489/the-pharmaceutical-industry-in-figures-edition-2011.pdf
2010: https://www.sfee.gr/wp-content/uploads/2015/05/EFPIA_Figures_2012_Final.pdf
Data for 2011 could not be found 
2012: https://www.phar-in.eu/wp-content/uploads/2014/05/Figures_2014_Final.pdf 
2013: https://www.efpia.eu/media/25822/2015-the-pharmaceutical-industry-in-figures.pdf
2014: https://www.efpia.eu/media/25055/the-pharmaceutical-industry-in-figures-june-2016.pdf
2015: https://www.efpia.eu/media/219735/efpia-pharmafigures2017_statisticbroch_v04-final.pdf
2016: https://www.efpia.eu/media/361960/efpia-pharmafigures2018_v07-hq.pdf
2017: https://www.efpia.eu/media/412931/the-pharmaceutical-industry-in-figures-2019.pdf
2018: https://www.efpia.eu/media/554521/efpia_pharmafigures_2020_web.pdf
2019: https://www.efpia.eu/media/602709/the-pharmaceutical-industry-in-figures-2021.pdf
2020: https://www.efpia.eu/media/637143/the-pharmaceutical-industry-in-figures-2022.pdf
2021: https://www.efpia.eu/media/rm4kzdlx/the-pharmaceutical-industry-in-figures-2023.pdf


```{r}
efpia_rd <- read.csv("/Users/benasmith/Desktop/Research Proj/Pharma Proj/Compiled Report/Cleaned Data/Area Level R&D Spending/EFPIA R&D Spending by Country in EU.csv")
efpia_rd <- clean_names(efpia_rd)
efpia_rd
```


formatting
```{r}
efpia_rd$r_d_spending_millions_euros <- gsub(",", "", efpia_rd$r_d_spending_millions_euros)
efpia_rd$r_d_spending_millions_euros <- as.numeric(efpia_rd$r_d_spending_millions_euros)
efpia_rd
```

sum total EU by year
```{r}
efpia_rd_totals <- efpia_rd %>%
  group_by(year) %>%
  summarise(total_euros = sum(r_d_spending_millions_euros, na.rm = TRUE))
efpia_rd_totals

```


Dollars to euros
https://www.macrotrends.net/2548/euro-dollar-exchange-rate-historical-chart 
```{r}
usdtoeuroavgconversion <- read_xlsx("/Users/benasmith/Desktop/Research Proj/Pharma Proj/Compiled Report/Cleaned Data/Area Level R&D Spending/USD to Euro Conversion Avg byt Year.xlsx")
usdtoeuroavgconversion
eurotodollars <- as.data.frame(cbind(usdtoeuroavgconversion$Year, 1/usdtoeuroavgconversion$`Average Closing Price`))
colnames(eurotodollars) <- c("year", "euros_to_dollar_conversion")
eurotodollars
```


multiply conversion rate to get r&d spending in dollars
```{r}
merged_df <- merge(efpia_rd_totals, eurotodollars, by = "year")
merged_df
efpia_rd_totals$total_dollars <- merged_df$euros_to_dollar_conversion * merged_df$total_euros
efpia_rd_totals
```


## get EU orphan drugs 
```{r}
eu_orphan_drugs <- read_xlsx("/Users/benasmith/Desktop/Research Proj/Pharma Proj/Compiled Report/Cleaned Data/Area Level Orphan Authorizations/EU_Orphan_w_Company from https___www.orpha.net_orphacom_cahiers_docs_GB_list_of_orphan_drugs_in_europe.pdf.xlsx")
eu_orphan_drugs <- clean_names(eu_orphan_drugs)
head(eu_orphan_drugs)
```

EU number of market authorizations for each drug. 
```{r}
eu_new_ma_freq <- eu_orphan_drugs %>%
  count(tradename) %>%
  arrange(desc(n))
eu_new_ma_freq
```

```{r}
eu_orphan_drugs[eu_orphan_drugs$tradename == "CARBAGLU",]
eu_orphan_drugs[eu_orphan_drugs$tradename == "NEXAVAR",]
eu_orphan_drugs[eu_orphan_drugs$tradename == "SOLIRIS",]

```

Select only new drugs in the EU
```{r}
eu_orphan_drugs <- eu_orphan_drugs %>%
  group_by(tradename) %>%  
  slice_min(order_by = market_authorization_year, n = 1, with_ties = FALSE) %>%  # Select the entry with the earliest market authorization year
  ungroup() 

eu_orphan_drugs
```




format by year
```{r}
eu_od_freqs_by_year <- as.data.frame(table(eu_orphan_drugs$market_authorization_year))
colnames(eu_od_freqs_by_year) <- c("Year", "Freq Orphan Drugs")
eu_od_freqs_by_year

eu_od_freqs_by_year$Year <- as.character(eu_od_freqs_by_year$Year)
eu_od_freqs_by_year$Year <- as.numeric(eu_od_freqs_by_year$Year)
eu_od_freqs_by_year <- eu_od_freqs_by_year[order(-eu_od_freqs_by_year$Year),] 
head(eu_od_freqs_by_year)
```



#merge orphan drug and R&D spending tables
```{r}
colnames(efpia_rd_totals) <- c("Year", "total_rd_euros", "total_rd_dollars")
eu_rd_ods <- merge(efpia_rd_totals,eu_od_freqs_by_year,by="Year")
eu_rd_ods <- clean_names(eu_rd_ods)
eu_rd_ods
```



# PhRMA
## get PhRMA R&D spending
https://phrma.org/-/media/Project/PhRMA/PhRMA-Org/PhRMA-Refresh/Report-PDFs/P-R/PhRMA_membership-survey_2022_final.pdf 
```{r}
phrma_us_rd <- read.csv("/Users/benasmith/Desktop/Research Proj/Pharma Proj/Compiled Report/Cleaned Data/Area Level R&D Spending/US Domestic R&D and R&D Abroad,* PhRMA Member Companies- 1983â€“2021 (dollar figures in millions) .csv")
head(phrma_us_rd)
```

## get US orphan drug Market Authorizations
```{r}
us_orphan_drugs <- read_xlsx("/Users/benasmith/Desktop/Research Proj/Pharma Proj/Compiled Report/Cleaned Data/Area Level Orphan Authorizations/US_Approved_and_MarketApproved_OrphanDrugs.xlsx")
us_orphan_drugs
```

Using generic name instead of tradename because many drugs in the US have tradename = NA but none have generic name = NA
```{r}
us_new_ma_freq <- us_orphan_drugs %>%
  count(Generic.Name) %>%
  arrange(desc(n))
us_new_ma_freq

us_new_ma_freq <- us_orphan_drugs %>%
  count(Trade.Name) %>%
  arrange(desc(n))
us_new_ma_freq
```

```{r}
us_orphan_drugs[us_orphan_drugs$Generic.Name == "ibrutinib",]
us_orphan_drugs[us_orphan_drugs$Generic.Name == "bevacizumab",]
us_orphan_drugs[us_orphan_drugs$Generic.Name == "olaparib",]
us_orphan_drugs[us_orphan_drugs$Trade.Name == "Gleevec",]


```

Select only new drugs in the US Using generic name instead of tradename because many drugs in the US have tradename = NA but none have generic name = NA
```{r}
us_orphan_drugs <- us_orphan_drugs %>%
  group_by(
Generic.Name) %>%  
  slice_min(order_by = Designation.Date, n = 1, with_ties = FALSE, na_rm=FALSE) %>%  # Select the entry with the earliest market authorization year
  ungroup() 

us_orphan_drugs
```

```{r}
us_new_ma_freq <- us_orphan_drugs %>%
  count(Trade.Name) %>%
  arrange(desc(n))
us_new_ma_freq
```


```{r}
us_new_ma_freq <- us_orphan_drugs %>%
  count(Generic.Name) %>%
  arrange(desc(n))
us_new_ma_freq
```
######How are there multiple generic names for one tradename???????????????

Check duplicated rows
```{r}
us_orphan_drugs[duplicated(us_orphan_drugs),]
eu_orphan_drugs[duplicated(eu_orphan_drugs),]
```

format MA date as year
```{r}
us_orphan_drugs$Marketing.year <- year(as.Date(us_orphan_drugs$Marketing.Approval.Date)) 
us_od_freqs_by_year <- as.data.frame(table(us_orphan_drugs$Marketing.year))
colnames(us_od_freqs_by_year) <- c("Year", "Freq Orphan Drugs")

us_od_freqs_by_year$Year <- as.character(us_od_freqs_by_year$Year)
us_od_freqs_by_year$Year <- as.numeric(us_od_freqs_by_year$Year)
us_od_freqs_by_year <- us_od_freqs_by_year[order(-us_od_freqs_by_year$Year),] 
head(us_od_freqs_by_year)
```


merge US orphan drug df with PhRMA r&d df
```{r}
phrma_us_rd <- phrma_us_rd[-dim(phrma_us_rd)[1],]
us_rd_ods <- merge(phrma_us_rd,us_od_freqs_by_year,by="Year")
```

```{r}
head(us_rd_ods)
```

format
```{r}
us_rd_ods$Domestic.R.D. <- parse_number(us_rd_ods$Domestic.R.D.)
us_rd_ods <- clean_names(us_rd_ods)
us_rd_ods
```

us dataframe simplified
```{r}
us_rd_od_simplified <- as.data.frame(cbind(us_rd_ods$year, us_rd_ods$domestic_r_d, us_rd_ods$freq_orphan_drugs))
colnames(us_rd_od_simplified) <- c("year", "annual_domestic_RD_spending_dollars", "freq_orphan_drugs")
us_rd_od_simplified$area <- rep("US", dim(us_rd_od_simplified)[1])
us_rd_od_simplified
```

eu dataframe simplified
```{r}
eu_rd_od_simplified <- as.data.frame(cbind(eu_rd_ods$year, eu_rd_ods$total_rd_dollars, eu_rd_ods$freq_orphan_drugs))
colnames(eu_rd_od_simplified) <- c("year", "annual_domestic_RD_spending_dollars", "freq_orphan_drugs")
eu_rd_od_simplified$area <- rep("EU", dim(eu_rd_od_simplified)[1])
eu_rd_od_simplified
```

# EU GDP Per Capita In Dollars
https://www.macrotrends.net/global-metrics/countries/EUU/european-union/gdp-per-capita
```{r}
eu_gdp_percapita_annual <- read.csv("/Users/benasmith/Desktop/Research Proj/Pharma Proj/Compiled Report/Cleaned Data/Area Level R&D Spending/GDP/european-union-gdp-per-capita-annual.csv", skip=16)
eu_gdp_percapita_annual$year <- year(as.Date(eu_gdp_percapita_annual$date))
eu_gdp_percapita_annual <- clean_names(eu_gdp_percapita_annual)
colnames(eu_gdp_percapita_annual)[2] <- "gdp_per_capita_usd"
eu_gdp_percapita_annual
```
# EU GDP Annual Growth Rate
https://www.macrotrends.net/global-metrics/countries/EUU/european-union/gdp-growth-rate 
```{r}
eu_gdp_growth_rate_annual <- read.csv("/Users/benasmith/Desktop/Research Proj/Pharma Proj/Compiled Report/Cleaned Data/Area Level R&D Spending/GDP/european-union-gdp-growth-rate.csv", skip=16)

eu_gdp_growth_rate_annual$year <- year(as.Date(eu_gdp_growth_rate_annual$date)) #format year


eu_gdp_growth_rate_annual <- clean_names(eu_gdp_growth_rate_annual)

colnames(eu_gdp_growth_rate_annual)[2] <- "gdp_growth_rate_annual"

eu_gdp_growth_rate_annual$gdp_growth_rate_annual <- eu_gdp_growth_rate_annual$gdp_growth_rate_annual/100 #convert to rate instead of percent

eu_gdp_growth_rate_annual
```

Merge GDP Per Capita, GDP Growth rate into same df

```{r}
eu_rd_od_simplified <- merge(eu_rd_od_simplified, eu_gdp_percapita_annual[,c("year", "gdp_per_capita_usd")], by = "year", all.x = TRUE)
eu_rd_od_simplified <- merge(eu_rd_od_simplified, eu_gdp_growth_rate_annual[,c("year", "gdp_growth_rate_annual")], by = "year", all.x = TRUE)
eu_rd_od_simplified
```


# US GDP Per Capita In Dollars
https://www.macrotrends.net/global-metrics/countries/USA/united-states/gdp-per-capita
```{r}
us_gdp_percapita_annual <- read.csv("/Users/benasmith/Desktop/Research Proj/Pharma Proj/Compiled Report/Cleaned Data/Area Level R&D Spending/GDP/united-states-gdp-per-capita-annual.csv", skip=16)
us_gdp_percapita_annual$year <- year(as.Date(us_gdp_percapita_annual$date))

us_gdp_percapita_annual <- clean_names(us_gdp_percapita_annual)

colnames(us_gdp_percapita_annual)[2] <- "gdp_per_capita_usd"
us_gdp_percapita_annual

```


# US GDP Annual Growth Rate
https://www.macrotrends.net/global-metrics/countries/USA/united-states/gdp-growth-rate 
```{r}
us_gdp_growth_rate_annual <- read.csv("/Users/benasmith/Desktop/Research Proj/Pharma Proj/Compiled Report/Cleaned Data/Area Level R&D Spending/GDP/united-states-gdp-growth-rate.csv", skip=16)
us_gdp_growth_rate_annual$year <- year(as.Date(us_gdp_growth_rate_annual$date))

us_gdp_growth_rate_annual <- clean_names(us_gdp_growth_rate_annual)

colnames(us_gdp_growth_rate_annual)[2] <- "gdp_growth_rate_annual"
us_gdp_growth_rate_annual$gdp_growth_rate_annual <- us_gdp_growth_rate_annual$gdp_growth_rate_annual/100 #convert to rate instead of percent

us_gdp_growth_rate_annual

```

Merge GDP Per Capita, GDP Growth rate into same df
```{r}
us_rd_od_simplified <- merge(us_rd_od_simplified, us_gdp_percapita_annual[,c("year", "gdp_per_capita_usd")], by = "year", all.x = TRUE)
us_rd_od_simplified <- merge(us_rd_od_simplified, us_gdp_growth_rate_annual[,c("year", "gdp_growth_rate_annual")], by = "year", all.x = TRUE)
us_rd_od_simplified
```

```{r}
combined_rd_od_df <- rbind(eu_rd_od_simplified, us_rd_od_simplified)
combined_rd_od_df <- combined_rd_od_df %>%
  filter(year > 2003)
combined_rd_od_df
```



```{r}
colorpallate <- c("#D81B60", "#1E88E5")
ggplot(combined_rd_od_df, aes(x = annual_domestic_RD_spending_dollars, y = freq_orphan_drugs, color = area)) +
  geom_point() +
  labs(x = "Annual Domestic RD Spending (Millions USD)",
       y = "Number of Market Authorized Orphan Drugs",
       color = "Area",
       title=str_wrap("Orphan Drug Market Authorizations by Annual Domestic R&D Spending in the EU and US", 60)) +
  scale_color_manual(values = colorpallate)+
  theme_minimal()
```



```{r}
ggplot(combined_rd_od_df, aes(x = year , y = freq_orphan_drugs, color = area)) +
  geom_line() +
  labs(x = "Year",
       y = "Number of Market Authorized Orphan Drugs",
       color = "Area",
       title="Orphan Drug Market Authorizations by Year in the EU and US") +
    theme_minimal() +
    scale_color_manual(values = colorpallate)
```


```{r}
ggplot(combined_rd_od_df, aes(x = year, y = annual_domestic_RD_spending_dollars, color = area)) +
  geom_line() +
  labs(x = "Year",
       y = "Annual Domestic R&D Spending (Millions USD)",
       color = "Area",
       title="Annual Domestic R&D Spending by Year in the EU and US") +
  scale_color_manual(values = colorpallate)+
  theme_minimal()
```




```{r}
ggplot(combined_rd_od_df, aes(x = year, y = gdp_per_capita_usd, color = area)) +
  geom_line() +
  labs(x = "Year",
       y = "GDP Per Capita on last day of Year (USD)",
       color = "Area",
       title="GDP Per Capita on last day of Year in the EU and US") +
  scale_color_manual(values = colorpallate)+
  theme_minimal()
```

```{r}
ggplot(combined_rd_od_df, aes(x = year, y = gdp_growth_rate_annual *100, color = area)) +
  geom_line() +
  labs(x = "Year",
       y = "GDP Annual Growth Rate (%)",
       color = "Area",
       title="GDP Annual Growth Rate over Time In EU and US") +
  scale_color_manual(values = colorpallate)+
  theme_minimal()
```



```{r}
plot(combined_rd_od_df[,-4], col=as.factor(combined_rd_od_df[,4]))
```

```{r}
subset(combined_rd_od_df, area=="US")
```

```{r}
hist(subset(combined_rd_od_df, area=="US")$freq_orphan_drugs, main="US Frequencies of Annual Orphan Drug Market Authorizations", xlab="Number of Annual US Orphan Drug Market Authorizations")
hist(subset(combined_rd_od_df, area=="EU")$freq_orphan_drugs, main="EU Frequencies of Annual Orphan Drug Market Authorizations",xlab="Number of Annual EU Orphan Drug Market Authorizations")
```




# Making a years after 2004 variable
```{r}
head(combined_rd_od_df)
combined_rd_od_df$yearsafter2004 <- combined_rd_od_df$year - 2004
```



# R&D Models
## Model of R&D Spending by area

```{r}
mod.rd.1 <- lm(annual_domestic_RD_spending_dollars ~  as.factor(area) , data=combined_rd_od_df)
summary(mod.rd.1)

residuals <- resid(mod.rd.1)
plot(residuals)

acf(residuals)
pacf(residuals)
mod.rd.nw.1 <- coeftest(mod.rd.1, vcov = NeweyWest(mod.rd.1, lag = 1, prewhite = FALSE))
mod.rd.nw.1
```


## Model of R&D spending by country and year without interaction
```{r}
mod.rd.2 <- lm(annual_domestic_RD_spending_dollars ~  as.factor(area) + yearsafter2004, data=combined_rd_od_df)
summary(mod.rd.2)

residuals <- resid(mod.rd.2)
plot(residuals)

acf(residuals)
pacf(residuals)
mod.rd.nw.2 <- coeftest(mod.rd.2, vcov = NeweyWest(mod.rd.2, lag = 1, prewhite = FALSE))
mod.rd.nw.2
```


## Model of R&D spending by country and year with interaction
```{r}
mod.rd.3 <- lm(annual_domestic_RD_spending_dollars ~  as.factor(area) * yearsafter2004, data=combined_rd_od_df)
summary(mod.rd.3)

residuals <- resid(mod.rd.3)
plot(residuals)

acf(residuals)
pacf(residuals)
mod.rd.nw.3 <- coeftest(mod.rd.3, vcov = NeweyWest(mod.rd.3, lag = 1, prewhite = FALSE))
mod.rd.nw.3
```


## Model of R&D spending by area and year adjusted for gdp growth rate 
```{r}
mod.rd.4 <- lm(annual_domestic_RD_spending_dollars ~  as.factor(area) + gdp_growth_rate_annual + yearsafter2004 + yearsafter2004:as.factor(area) , data=combined_rd_od_df)
summary(mod.rd.4)

residuals <- resid(mod.rd.4)
plot(residuals)

acf(residuals)
pacf(residuals)

mod.rd.nw.4 <- coeftest(mod.rd.4, vcov = NeweyWest(mod.rd.4, lag = 1, prewhite = FALSE))
mod.rd.nw.4

```


<!-- # ```{r} -->
<!-- # mod.rd.nw.1 <- gls(model=annual_domestic_RD_spending_dollars ~  as.factor(area) + gdp_per_capita_usd +yearsafter2004 + yearsafter2004*as.factor(area), data=combined_rd_od_df, corARMA(p = 0, q = 1)) -->
<!-- # summary(mod.rd.nw.1) -->
<!-- # ``` -->


<!-- ```{r} -->
<!-- tidy_mod.rd.nw.1 <- tidy(mod.rd.nw.1) -->
<!-- tidy_mod.rd.nw.1 <- tidy_mod.rd.nw.1 %>% mutate(Model = "Model 1") -->
<!-- combined_models <- bind_rows(tidy_mod.rd.nw.1) -->

<!-- formatted_table <- combined_models %>% -->
<!--   select(Model, term, estimate, std.error, statistic, p.value) %>% -->
<!--   pivot_wider(names_from = Model, values_from = c(estimate, std.error, statistic, p.value)) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- formatted_table -->
<!-- ``` -->




```{r}
stargazer(mod.rd.1, mod.rd.2, mod.rd.3, mod.rd.4, title="Model Coefficients (Not adjusted for ARMA Error Structure)", align=TRUE, type = "html", out="Final Models Formatted/rdmodelsNonAdjusted.htm",
          covariate.labels = c("US", "Annual GDP Growth Rate", "Years After 2004", "US:Years After 2004", "Intercept"),
          dep.var.labels=c("Annual R&D Spending (Million USD)"))
```


```{r}
stargazer(mod.rd.nw.1, mod.rd.nw.2, mod.rd.nw.3, mod.rd.nw.4, title="Newey-West Adjusted Models", align=TRUE, type = "html", out="Final Models Formatted/rdmodels.htm",
          covariate.labels = c("US", "Annual GDP Growth Rate", "Years After 2004", "US:Years After 2004", "Intercept"),
          dep.var.labels=c("Annual R&D Spending (Million USD)"))
```


# Number of Orphan Drug Models 
## Freq of orphan drugs by Domestic R&D, Area, and interaction, year
```{r}
mod.od.1 <- lm(freq_orphan_drugs ~ annual_domestic_RD_spending_dollars + as.factor(area)*yearsafter2004 + as.factor(area)*annual_domestic_RD_spending_dollars  , data=combined_rd_od_df)
summary(mod.od.1)

residuals <- resid(mod.od.1)
plot(residuals)

acf(residuals)
pacf(residuals)

mod.od.nw.1 <- coeftest(mod.od.1, vcov = NeweyWest(mod.od.1, lag = 1, prewhite = FALSE))
```

<!-- plm package -->
<!-- ```{r} -->
<!-- mod.rd.od <- plm(freq_orphan_drugs ~ as.numeric(annual_domestic_RD_spending_dollars) + as.factor(area) + as.factor(area)*as.numeric(annual_domestic_RD_spending_dollars), data=combined_rd_od_df, model="pooling") -->
<!-- #summary(mod.rd.od, vcov = vcovNW) -->
<!-- coeftest(mod.rd.od, vcov.=vcovNW) -->
<!-- ``` -->


- take out interaction and see what the indicator is 
- then put in year as a factor 



## Freq of orphan drugs by Domestic R&D, Area, and interaction and GDP growth rate
```{r}
mod.od.2 <- lm(freq_orphan_drugs ~ annual_domestic_RD_spending_dollars + as.factor(area)*yearsafter2004 + gdp_growth_rate_annual + as.factor(area)*annual_domestic_RD_spending_dollars , data=combined_rd_od_df)
summary(mod.od.2)

residuals <- resid(mod.od.2)
plot(residuals)

acf(residuals)
pacf(residuals)

mod.od.nw.2 <- coeftest(mod.od.2, vcov = NeweyWest(mod.od.2, lag = 1, prewhite = FALSE))
```


```{r}
mod.od.nw.2
```

```{r}
confint(mod.od.nw.2)
```

With 95% confidence, after adjusting for annual R&D spending and annual GDP growth rate, a one-year increase is associated with between a further 1.19 and 7 million dollar increase in the number of market-authorized orphan drugs compared to the EU

With 95% confidence, after adjusting for annual R&D spending and annual GDP growth rate, a one-year increase is associated with between a further 1.19 and 7 million dollar increase in the number of market-authorized orphan drugs compared to the EU

## Freq of orphan drugs by Domestic R&D in the US with GDP growth, no area/ spending interaction
```{r}
mod.od.3 <- lm(freq_orphan_drugs ~ annual_domestic_RD_spending_dollars + as.factor(area) * yearsafter2004 + gdp_growth_rate_annual  , data=combined_rd_od_df)
summary(mod.od.3)

residuals <- resid(mod.od.3)
plot(residuals)

acf(residuals)
pacf(residuals)

mod.od.nw.3 <-coeftest(mod.od.3, vcov = NeweyWest(mod.od.3, lag = 1, prewhite = FALSE))
```

## Freq of orphan drugs by Domestic R&D in the US no area/ spending interaction or gdp growth rate
```{r}
mod.od.4 <- lm(freq_orphan_drugs ~ annual_domestic_RD_spending_dollars + as.factor(area) * yearsafter2004  , data=combined_rd_od_df)
summary(mod.od.4)

residuals <- resid(mod.od.4)
plot(residuals)

acf(residuals)
pacf(residuals)

mod.od.nw.4 <-coeftest(mod.od.4, vcov = NeweyWest(mod.od.4, lag = 1, prewhite = FALSE))
```

## Freq of orphan drugs by US over time - no interaction
```{r}
mod.od.5 <- lm(freq_orphan_drugs ~ as.factor(area) + yearsafter2004  , data=combined_rd_od_df)

residuals <- resid(mod.od.5)
plot(residuals)

acf(residuals)
pacf(residuals)

mod.od.nw.5 <-coeftest(mod.od.5, vcov = NeweyWest(mod.od.5, lag = 1, prewhite = FALSE))
```



## Freq of orphan drugs by US over time - interaction
```{r}
mod.od.6 <- lm(freq_orphan_drugs ~ as.factor(area) * yearsafter2004  , data=combined_rd_od_df)

residuals <- resid(mod.od.6)
plot(residuals)

acf(residuals)
pacf(residuals)

mod.od.nw.6 <- coeftest(mod.od.6, vcov = NeweyWest(mod.od.6, lag = 1 , prewhite = FALSE))
```

```{r}
stargazer(mod.od.5, mod.od.6, mod.od.4, mod.od.1, mod.od.3, mod.od.2, title="Model Coefficients (Not adjusted for ARMA Error Structure)", align=TRUE, type = "html", out="Final Models Formatted/orphandrugmodelsNonAdjusted.htm",
          covariate.labels = c("Annual Domestic R&D Spending (Millions USD)", "US", "Years After 2004",  "Annual GDP Growth Rate", "Years After 2004:US", "Annual Domestic R&D Spending (Millions USD):US" , "Intercept"),
          dep.var.labels=c("Annual Number of Market Authorized Orphan Drugs")
          )
```

```{r}
#creating shorter names because stargazer has a length limit for the input of all models

m1 <- mod.od.nw.1
m2 <- mod.od.nw.2
m3 <- mod.od.nw.3
m4 <- mod.od.nw.4
m5 <- mod.od.nw.5 
m6 <- mod.od.nw.6

stargazer(m5,m6,m4,m1,m3,m2, title="Newey-West Adjusted Models", align=TRUE, type = "html", out="Final Models Formatted/orphandrugmodels.htm",
          covariate.labels = c("Annual Domestic R&D Spending (Millions USD)", "US", "Years After 2004",  "Annual GDP Growth Rate", "Years After 2004:US", "Annual Domestic R&D Spending (Millions USD):US" , "Intercept"),
          dep.var.labels=c("Annual Number of Market Authorized Orphan Drugs")
          )
```






















- interaction btw area and r&d 


- look in literature and see if policy chances 
list policy change by year 


- intervention shock that stays - indicator 1 where policy is 0 where its not 


- line plot instead of points 

- subset on same time frame - find eu data if possible but if not available then subset us 



- add graphs and stuff to lit review 
- add tables to 



- change gdp to % change in gdp - quarterly Federal reserve FRED 



```{r}

mod.od.2 <- lm(freq_orphan_drugs ~ annual_domestic_RD_spending_dollars + yearsafter2004 + gdp_growth_rate_annual + annual_domestic_RD_spending_dollars , data=combined_rd_od_df)
summary(mod.od.2)

residuals <- resid(mod.od.2)
plot(residuals)

acf(residuals)
pacf(residuals)

mod.od.nw.2 <- coeftest(mod.od.2, vcov = NeweyWest(mod.od.2, lag = 1, prewhite = FALSE))
```


```{r}
combined_rd_od_df
```

Overall mean of Domestic R&D spending
```{r}
mean(combined_rd_od_df$annual_domestic_RD_spending_dollars)
```




Overall mean of US Domestic R&D spending
```{r}
mean(subset(combined_rd_od_df ,area=="US")$annual_domestic_RD_spending_dollars)
```




Overall mean of annual EU Domestic R&D spending 
```{r}
mean(subset(combined_rd_od_df ,area=="EU")$annual_domestic_RD_spending_dollars)
```



Overall mean of annual number of US Market Authroized Orphan Drugs
```{r}
mean(subset(combined_rd_od_df ,area=="US")$freq_orphan_drugs)
```



Overall mean of annual number of EU Market Authroized Orphan Drugs
```{r}
mean(subset(combined_rd_od_df ,area=="EU")$freq_orphan_drugs)
```


```{r}
1405.560/36036.42
```



# Poisson Model

```{r}
poismod1 <- glm(freq_orphan_drugs ~ annual_domestic_RD_spending_dollars + as.factor(area)*yearsafter2004 + gdp_growth_rate_annual + as.factor(area)*annual_domestic_RD_spending_dollars , data=combined_rd_od_df, family=poisson(link="log")) 
summary(poismod1, exponentiate=TRUE)

residuals <- resid(poismod1)
plot(residuals)
acf(residuals)
pacf(residuals)

#coeftest(poismod1, vcov = NeweyWest(poismod1, lag = 1, prewhite = FALSE))

```





# Total Drug production 
# US 

```{r}
ApplicationDocs <- read.delim("/Users/benasmith/Downloads/datfda20240903/ApplicationDocs.txt")
Products <- read.delim("/Users/benasmith/Downloads/datfda20240903/Products.txt")
USDrugs <- merge(ApplicationDocs, Products, by = "ApplNo")
USDrugs
```






